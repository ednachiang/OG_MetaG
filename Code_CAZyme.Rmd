---
title: "CAZyme Code"
author: "Edna Chiang"
date: "2/9/2021"
output: html_document
---

### Load Libraries
```{r}
library('readr')
library('pgirmess')
library('ggplot2')
library('grid')
library('phyloseq')
library('DESeq2')
library('phangorn')
library('vegan')
library('pheatmap')
library('RColorBrewer')
library('gplots')
library('tidyr')
library('dplyr')
library('stringr')
library('lme4')
library('picante')
library('ggdendro')
library('fitdistrplus')
library('amap')
library('labdsv')
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/misc.R')
source('scripts/simper.R')
source('scripts/pairwise.adonis.R')
```


### dbCAN - Proportion CAZymes from ORFs
```{r}
prodigalCounts <- read.csv('dbcan/prodigalCounts.csv', row.names=1)
prodigalCounts <- as.matrix(prodigalCounts)
# Test normality
hist(prodigalCounts[3,])
qqnorm(prodigalCounts[3,])
qqline(prodigalCounts[3,])
shapiro.test(prodigalCounts[3,])
  # p-value = 0.001575
  # Not Normal
# Format for Kruskal-Wallis
prodigalCounts <- read.csv('dbcan/prodigalCounts.csv', row.names=1)
prodigalCounts <- t(prodigalCounts)
prodigalCounts <- data.frame(prodigalCounts)
prodigalCounts$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
prodigalCounts$Season <- ordered(prodigalCounts$Season, levels=c("Summer", "Winter", "Spring"))
prodigalCounts$Diet <- c("Feeding", "Feeding", "Fasting", "Fasting", "Feeding", "Feeding", "Fasting", "Feeding", "Feeding")
prodigalCounts$Diet <- ordered(prodigalCounts$Diet, levels=c("Feeding", "Fasting"))
colnames(prodigalCounts) <- c("Total_ORFs", "Total_CAZymes", "CAZymePercentage", "Season", "Diet")
# Test w/ Kruskal-Wallis
kruskal.test(formula = CAZymePercentage ~ Season, data = prodigalCounts)
  # p-value = 0.5611
kruskal.test(formula = CAZymePercentage ~ Diet, data = prodigalCounts)
  # p-value = 0.4386
### Dot plot
#tiff("dbcan.prop.tiff", width=5, height=4, units="in", res= 300)
ggplot(prodigalCounts, aes(x=Season, y=CAZymePercentage, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, stackratio=1.15) +
  ylab("% ORFs annotated as CAZyme (%)") +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_y_continuous(breaks = c(2.0, 2.6, 3.2, 3.8, 4.4), limits=c(2.0, 4.4)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"))
#dev.off()
```
### dbCAN - Create phyloseq object (DO NOT RUN!!!)
```{r}
# Load data
#otu <- read.csv('dbcan/dbcan_otu_table.csv', row.names=1)
#colnames(otu) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
#tax <- read.csv('dbcan/dbcan_tax_table.csv', row.names=1)
#tax <- tax_table(tax)
#colnames(tax) <- c("Class", "Family")
#taxa_names(tax) <- tax[,2]
meta <- read.csv('dbcan/dbcan.spades.metadata.csv', row.names=1)
#meta.ord <- meta

# Remove CAZymes that appear in only 1 sample
cazy.rem <- list()
for(i in 1:nrow(otu)){
  empty <- length(which(otu[i,] == 0))
    # Identifies # of samples w/o CAZyme
  if(empty > 7){
    # If CAZyme appears in only 1 sample
    cazy.rem <- append(cazy.rem, i)
      # Create list of CAZymes that appear in only 1 sample
  }
}
cazy.rem.row <- as.numeric(cazy.rem)
  # Convert list to numeric

# Remove CAZymes that appear in only 1 sample
otu.rem <- otu[-cazy.rem.row,]
  # 16 CAZymes = GH107, GT67, GH149, GT68, GT42, PL16, PL2, PL28, GT52, GH34, GT61, GT77, GH12, PL18, GT85, GT93

# Convert trimmed CAZyme table to otu_table
otu.rem.tab <- otu_table(otu.rem, taxa_are_rows = T)


# Create phyloseq object
dbcan.phy <- merge_phyloseq(otu.rem.tab, tax, sample_data(meta.ord))
#save(dbcan.phy, file = "dbcan.phy.Rdata")

# Normalized Counts At Family-level
# https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html
#otu.rem <- data.frame(otu_table(dbcan.phy))
#dbcan.dds <- DESeqDataSetFromMatrix(countData = otu.rem, colData = meta, design = ~ Season)
#dbcan.dds <- estimateSizeFactors(dbcan.dds)
#dbcan.norm <- counts(dbcan.dds, normalized=T)
#write.csv(dbcan.norm, file="dbcan/dbcan.Normalized.Counts.Family.csv")

dbcan.fam.norm <- read.csv('dbcan/dbcan.Normalized.Counts.Family.csv', row.names=1)
dbcan.fam.norm.otu <- otu_table(dbcan.fam.norm, taxa_are_rows=T)
sample_names(dbcan.fam.norm.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
dbcan.fam.norm.phy <- merge_phyloseq(dbcan.fam.norm.otu, sample_data(dbcan.phy), tax_table(dbcan.phy))
#save(dbcan.fam.norm.phy, file = "dbcan.fam.norm.phy.RData")

# Normalize Counts to Class-Level
#dbcan.class <- tax_glom(dbcan.phy, taxrank="Class")
#dbcan.class.otu <- data.frame(otu_table(dbcan.class))
#dbcan.dds <- DESeqDataSetFromMatrix(countData = dbcan.class.otu, colData = meta, design = ~ Season)
#dbcan.dds <- estimateSizeFactors(dbcan.dds)
#dbcan.norm <- counts(dbcan.dds, normalized=T)
#write.csv(dbcan.norm, file="dbcan/dbcan.Normalized.Counts.Class.csv")

dbcan.class.norm <- read.csv('dbcan/dbcan.Normalized.Counts.Class.csv', row.names=1)
rownames(dbcan.class.norm) <- c("Polysaccharide Lyase", "Glycosyltransferase", "Glycoside Hydrolase", "Carbohydrate Esterase")

# Pairwise season physeq objects
#dbcan.sw <- subset_samples(dbcan99, Season != "Spring")
  # Summer & Winter
#dbcan.sp <- subset_samples(dbcan99, Season != "Winter")
  # Summer & Spring
#dbcan.wp <- subset_samples(dbcan99, Season != "Summer")
  # Winter & Spring
```
### dbCAN - Load phyloseq object
```{r}
# Load data
meta <- read.csv('dbcan/dbcan.spades.metadata.csv', row.names=1)
load("dbcan.phy.Rdata")
dbcan.fam.norm <- read.csv('dbcan/dbcan.Normalized.Counts.Family.csv', row.names=1)
load("dbcan.fam.norm.phy.RData")
dbcan.class.norm <- read.csv('dbcan/dbcan.Normalized.Counts.Class.csv', row.names=1)
rownames(dbcan.class.norm) <- c("Polysaccharide Lyase", "Glycosyltransferase", "Glycoside Hydrolase", "Carbohydrate Esterase")
```


### dbCAN - Count unique CAZyme families
```{r}
# Subset out samples by season
phy.sum <- subset_samples(dbcan.phy, Season == "Summer")
phy.win <- subset_samples(dbcan.phy, Season == "Winter")
phy.spr <- subset_samples(dbcan.phy, Season == "Spring")


# Pull out unique CAZyme families in each season and order alphabetically
sum.fam <- get_taxa_unique(phy.sum, "Family")
sum.fam <- sort(sum.fam)
win.fam <- get_taxa_unique(phy.win, "Family")
win.fam <- sort(win.fam)
spr.fam <- get_taxa_unique(phy.spr, "Family")
spr.fam <- sort(spr.fam)


# Summer - Count # of CAZymes in each class
class <- substr(sum.fam,1,2)
length(which(class == "GH"))
  # 129
length(which(class == "GT"))
  # 67
length(which(class == "CE"))
  # 15
length(which(class == "PL"))
  # 28


# Winter - Count # of CAZymes in each class
class <- substr(win.fam,1,2)
length(which(class == "GH"))
  # 129
length(which(class == "GT"))
  # 67
length(which(class == "CE"))
  # 15
length(which(class == "PL"))
  # 28


# Spring - Count # of CAZymes in each class
class <- substr(spr.fam,1,2)
length(which(class == "GH"))
  # 129
length(which(class == "GT"))
  # 67
length(which(class == "CE"))
  # 15
length(which(class == "PL"))
  # 28

```

### dbCAN - Class-level bar plot
```{r}
# Create phyloseq object to summarize data
class.tax <- data.frame(c("Carbohydrate Esterase", "Glycoside Hydrolase", "Glycosyltransferase", 
                          "Polysaccharide Lyase"))
class.tax <- tax_table(class.tax)
row.names(class.tax) <- class.tax[,1]
colnames(class.tax) <- "Class"
dbcan.class.norm.otu <- otu_table(dbcan.class.norm, taxa_are_rows=T)
colnames(dbcan.class.norm.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
dbcan.class.phy <- merge_phyloseq(dbcan.class.norm.otu, class.tax, sample_data(meta))

# Summarize data
dbcan.class.df <- psmelt(dbcan.class.phy)
dbcan.class.sum <- dbcan.class.df %>%
  group_by(Class, Season) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))
dbcan.class.sum$Class <- ordered(dbcan.class.sum$Class, c("Glycoside Hydrolase",
                                                                  "Glycosyltransferase",
                                                                  "Carbohydrate Esterase",
                                                                  "Polysaccharide Lyase"))
dbcan.class.sum$Season <- ordered(dbcan.class.sum$Season, levels = c("Summer", "Winter", "Spring"))

# Plot barplot
#tiff("dbcan.class.tiff", width=10, height=4, units="in", res= 300)
ggplot(dbcan.class.sum, aes(x=Season, y=Mean, fill=Season)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=Mean+SE, ymin=Mean-SE), width=0.25) +
  scale_y_continuous(limits=c(0,9500)) +
  facet_grid(. ~ Class) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  xlab("CAZyme Class") +
  ylab("Mean Normalized Counts") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_text(margin = margin(t = 20)))
#dev.off()


```

### dbCAN - Test class-level
```{r}
# Same results if you compare Diet (Feeding vs. Fasting)
### CE
ce <- dbcan.class.df[which(dbcan.class.df$Class == "Carbohydrate Esterase"),]

# Test normality
hist(ce$Abundance)
qqnorm(ce$Abundance)
qqline(ce$Abundance)
shapiro.test(ce$Abundance)
  # p-value = 0.6876
  # Normal

# Test CE w/ ANOVA
summary(aov(Abundance ~ Season, data = ce))
  # p-value = 0.33



### GH
gh <- dbcan.class.df[which(dbcan.class.df$Class == "Glycoside Hydrolase"),]

# Test normality
hist(gh$Abundance)
qqnorm(gh$Abundance)
qqline(gh$Abundance)
shapiro.test(gh$Abundance)
  # p-value = 0.4787
  # Normal

# Test GH w/ ANOVA
summary(aov(Abundance ~ Season, data = gh))
  # p-value = 0.00789

# GH posthoc test w/ Tukey's
TukeyHSD(aov(Abundance ~ Season, data = gh))
  # Summer-Spring = 0.0296082*
  # Winter-Spring = 0.0076523**
  # Winter-Summer = 0.4785787



### GT
gt <- dbcan.class.df[which(dbcan.class.df$Class == "Glycosyltransferase"),]

# Test normality
hist(gt$Abundance)
qqnorm(gt$Abundance)
qqline(gt$Abundance)
shapiro.test(gt$Abundance)
  # p-value = 0.4392
  # Normal

# Test GT w/ ANOVA
summary(aov(Abundance ~ Season, data = gt))
  # p-value = 0.00722

# GT posthoc test w/ Tukey's
TukeyHSD(aov(Abundance ~ Season, data = gt))
  # Summer-Spring = 0.35088173
  # Winter-Spring = 0.0065675**
  # Winter-Summer = 0.0343926*



### PL
pl <- dbcan.class.df[which(dbcan.class.df$Class == "Polysaccharide Lyase"),]

# Test normality
hist(pl$Abundance)
qqnorm(pl$Abundance)
qqline(pl$Abundance)
shapiro.test(pl$Abundance)
  # p-value = 0.08761
  # Normal

# Test PL w/ ANOVA
summary(aov(Abundance ~ Season, data = pl))
  # p-value = 0.114




### Adjust Pvals
p.adjust(c(0.33, 0.00789, 0.00722, 0.114), method="BH")
  # CE = 0.33000
  # GH = 0.01578 *
  # GT = 0.01578 *
  # PL = 0.15200


```












### dbCAN - Create DESeq Object
```{r}
# https://www.bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html
# https://compbiocore.github.io/deseq-workshop-1/assets/deseq_workshop_1.html
# https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html
# Use UN-NORMALIZED data!!!
  # DESeq accounts for library size


### Test DESeq2 to determine fit type
# https://support.bioconductor.org/p/81094/
#dbcan.dds <- phyloseq_to_deseq2(dbcan.phy, ~Season)
#dbcan.dds$Season <- factor(dbcan.dds$Season, levels=c("Summer", "Winter", "Spring"))
#dbcan.dds <- dbcan.dds[rowSums(counts(dbcan.dds)) > 1,]
#dbcan.local <- DESeq(dbcan.dds, fitType = "local")
#dbcan.par <- DESeq(dbcan.dds, fitType = "parametric")
#mad(log(mcols(dbcan.local)$dispGeneEst) - log(mcols(dbcan.local)$dispFit))
  # 10.71774
#mad(log(mcols(dbcan.par)$dispGeneEst) - log(mcols(dbcan.par)$dispFit))
  # 7.483878
# Parametric is a better fit (lower median absolute residual) than local

### Convert phyloseq object to deseq2 object
dbcan.dds <- phyloseq_to_deseq2(dbcan.phy, ~Season)
  # Design variable must be unordered otherwise you get an error
dbcan.dds$Season <- factor(dbcan.dds$Season, levels=c("Summer", "Winter", "Spring"))

# DESeq DataStructure for analyses
dbcan.dds <- DESeq(dbcan.dds)

# Hellinger-transformed data for visualizations
dbcan.hell <- hellinger(t(assay(dbcan.dds)))
```
### dbCAN - DESeq - find overrep genes
```{r}
# Pull out results from pairwise comparison
dbcan.sw <- results(dbcan.dds, contrast=c("Season", "Summer", "Winter"))
dbcan.sw.sig <- dbcan.sw[which(dbcan.sw$padj < 0.05),]
  # Enriched in Summer compared to Winter (positive log2FoldChange)
    # GT101, PL1, GH43, GH115, CE12, GH10
dbcan.sp <- results(dbcan.dds, contrast=c("Season", "Summer", "Spring"))
dbcan.sp.sig <- dbcan.sp[which(dbcan.sp$padj < 0.05),]
  # Enriched in Summer compared to Spring (positive log2FoldChange)
    # GT101
dbcan.wp <- results(dbcan.dds, contrast=c("Season", "Winter", "Spring"))
dbcan.wp.sig <- dbcan.wp[which(dbcan.wp$padj < 0.05),]
dbcan.wp.sig[which(dbcan.wp.sig$log2FoldChange > 0),]
  # Enriched in Winter compared to Spring (positive log2FoldChange)
      # GT41, GH20, GT4, GT9, CE11, GT3, GH84
dbcan.wp.sig[which(dbcan.wp.sig$log2FoldChange < 0),]
  # Enriched in Spring compared to Winter (negative log2FoldChange)
    # GH3, GH32, GH43, GH5, GH78, GH115, GH42, CE12, GH106, GH10, GH39
```


### dbCAN - DESeq heatmap of normalized + transformed counts
```{r}
# Note: I tried merging the samples by season so the heatmap only displays Summer, Winter, and Spring, but I get an error that say I have insufficient data. Therefore, I display each sample separately.

# Excluding some families because they has such high counts that it makes the heatmap hard to interpret visually
# I'll make a separate plot for just GH43, GH3, GT4, and GT41

dbcan.hell.otu <- otu_table(t(dbcan.hell), taxa_are_rows = T)
colnames(dbcan.hell.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744",
                              "3772", "3773" , "3775")
dbcan.sig <- merge_phyloseq(dbcan.hell.otu, tax_table(dbcan.phy),
                            sample_data(dbcan.phy))
dbcan.sig <- subset_taxa(dbcan.sig, Family == "GT101" | Family == "PL1" |
                           Family == "GH10" | Family == "GH43" | Family == "GH115" |
                           Family == "CE12" | Family == "GH3" | Family == "GH5" |
                           Family == "GH32" | Family == "GH39" | Family == "GH42" |
                           Family == "GH78" | Family == "GH106" | Family == "GH20" |
                           Family == "GH84" | Family == "GT3" | Family == "GT4" |
                           Family == "GT9" | Family == "GT41" | Family == "CE11")



#tiff("dbcan.heatmap.tiff", width=8.4, height=10, units="in", res=300)
plot_heatmap(dbcan.sig, sample.label = "Season", sample.order = c("3715", "3717", "3744", "3723", "3733", "3772", "3734", "3773", "3775"), taxa.order = c("CE11", "GT41", "GT9", "GT4", "GT3", "GH84", "GH20", "GH106", "GH78", "GH42", "GH39", "GH32", "GH5", "GH3", "CE12", "GH115", "GH43", "GH10", "PL1", "GT101")) +
  geom_tile(colour="gray40") +
  scale_x_discrete(position = "top", labels=c("Summer", "Summer", "Summer", "Winter", "Winter", "Winter", "Spring", "Spring", "Spring")) +
  xlab("Season\n\n") +
  ylab("CAZyme Family\n\n") +
  scale_fill_gradientn(name=expression("Hellinger-\nTransformed\nNormalized\nCounts\n"), limits = c(0.02,0.27),
                       breaks = c(0.02, 0.07, 0.12, 0.17, 0.22, 0.27),
                       labels = c("0.02", "0.07", "0.12", "0.17", "0.22", "0.27"),
                       colours = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976",
                                   "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c",
                                   "#bd0026", "#800026", "#33000f")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=20),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=20, face="bold"),
        axis.title.y = element_text(size=20, face="bold"),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20)) +
  guides(fill = guide_colorbar(barheight = unit(7,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()
```





### dbCAN - DESeq sample dist heatmap / dendrogram
``` {r}
# https://www.bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#exploring-and-exporting-results
# http://bioconductor.org/packages/devel/workflows/vignettes/rnaseqGene/inst/doc/rnaseqGene.html

dbcan.dist <- dist(dbcan.hell, method = "euclidean")
dbcan.dist.matrix <- as.matrix(dbcan.dist)
rownames(dbcan.dist.matrix) <- meta$Season
colnames(dbcan.dist.matrix) <- meta$Season

# Heatmap
#pheatmap(dbcan.dist.matrix, clustering_distance_rows = dbcan.dist, clustering_distance_cols = dbcan.dist, col = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026"))

# Dendrogram
dbcan.hclust <- hclust(dbcan.dist, method = "average")
dbcan.den <- as.dendrogram(dbcan.hclust)
dbcan.den.data <- dendro_data(dbcan.den, type="rectangle")
dbcan.den.data$labels[,3] <- c("Summer", "Winter", "Winter", "Winter", "Summer", "Spring", "Spring", "Spring", "Summer")
dbcan.den.data$labels[,3] <- ordered(dbcan.den.data$labels[,3], levels=c("Summer", "Winter", "Spring"))

#tiff("dbcan.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(dbcan.den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = dbcan.den.data$labels, aes(x, y, label=label, colour=label, fontface = "bold"),
            hjust=0, size=5) +
  ylab("Hellinger Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("darkgoldenrod3", "dodgerblue3", "green4")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()


```

### dbCAN - Sample dist PCoA & PERMANOVA
```{r}
dbcan.pcoa <- pcoa(dbcan.dist)
  # Total var explained = 65.1
dbcan.phy.ord <- dbcan.phy
sample_data(dbcan.phy.ord)$Season <- ordered(sample_data(dbcan.phy.ord)$Season, levels = c("Summer", "Winter", "Spring"))

#tiff("dbcan.pcoa.tiff", width=8, height=6, units="in", res=300)
plot_ordination(physeq = dbcan.phy.ord, ordination = dbcan.pcoa, axes = c(1,2),
                color = "Season") +
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Hellinger Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))
#dev.off()


### Test normality
hist(dbcan.dist)
qqnorm(dbcan.dist)
qqline(dbcan.dist)
shapiro.test(dbcan.dist)
  # p-value = 0.4953
  # Normal

### Run PERMANOVA on DESEq Kendall distance
adonis(dbcan.dist ~ Season, data=meta, permutations = 99999)
  # p-value = 0.0072
beta.tax = betadisper(d=dbcan.dist, group=meta$Season) 
p <- permutest(beta.tax)
p$tab
  # p-value = 0.587



### Pairwise PERMANOVA Comparisons
dbcan.dist.matrix <- as.matrix(dbcan.dist)
dbcan.dist.df <- data.frame(dbcan.dist.matrix)

# Summer vs. Winter
dbcan.sw.dist.df <- dbcan.dist.df[,-5]
dbcan.sw.dist.df <- dbcan.sw.dist.df[,-7:-8]
dbcan.sw.dist.df <- dbcan.sw.dist.df[-5,]
dbcan.sw.dist.df <- dbcan.sw.dist.df[-7:-8,]
dbcan.sw.dist <- as.dist(dbcan.sw.dist.df)
meta.sw <- meta[-which(meta$Season == "Spring"),]
adonis(dbcan.sw.dist ~ Season, data=meta.sw, permutations= 99999)
  # p-value = 0.1

# Summer vs. Spring
dbcan.sp.dist.df <- dbcan.dist.df[,-3:-4]
dbcan.sp.dist.df <- dbcan.sp.dist.df[,-5]
dbcan.sp.dist.df <- dbcan.sp.dist.df[-3:-4,]
dbcan.sp.dist.df <- dbcan.sp.dist.df[-5,]
dbcan.sp.dist <- as.dist(dbcan.sp.dist.df)
meta.sp <- meta[-which(meta$Season == "Winter"),]
adonis(dbcan.sp.dist ~ Season, data=meta.sp, permutations= 99999)
  # p-value = 0.2

# Spring vs. Winter
dbcan.wp.dist.df <- dbcan.dist.df[,-3:-4]
dbcan.wp.dist.df <- dbcan.wp.dist.df[,-5]
dbcan.wp.dist.df <- dbcan.wp.dist.df[-3:-4,]
dbcan.wp.dist.df <- dbcan.wp.dist.df[-5,]
dbcan.wp.dist <- as.dist(dbcan.wp.dist.df)
meta.wp <- meta[-which(meta$Season == "Summer"),]
adonis(dbcan.wp.dist ~ Season, data=meta.wp, permutations= 99999)
  # p-value = 0.2
```

### dbCAN - Mucin-degrading CAZymes
```{r}
# List of mucin-degrading CAZymes
muc.enz <- c("GH2", "GH3", "GH4", "GH16", "GH18", "GH20", "GH27", "GH29", "GH31", "GH33", "GH35", "GH36", "GH38", "GH42", "GH67", "GH76", "GH84", "GH85", "GH89", "GH92", "GH95", "GH97", "GH98", "GH101", "GH109", "GH110", "GH112", "GH123", "GH125", "GH129", "GH130", "GH163")



# Pull out mucin-degrading CAZymes
for (i in 1:length(muc.enz)){
  
  if (i == 1){
    enz <- which(rownames(dbcan.fam.norm) == muc.enz[i])
    muc.df <- dbcan.fam.norm[enz,]
  }
  
  enz <- which(rownames(dbcan.fam.norm) == muc.enz[i])
  muc.df[i,] <- dbcan.fam.norm[enz,]
}
colnames(muc.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")

# Sum of mucin-degrading CAZymes
for (i in 1:ncol(muc.df)) {
  if (i == 1){
    muc.sum <- sum(muc.df[,i])
    muc.sum.df <- data.frame(muc.sum)
    colnames(muc.sum.df)[i] <- colnames(muc.df)[i]
  }
  muc.sum <- sum(muc.df[,i])
  muc.sum.df[,i] <- muc.sum
  colnames(muc.sum.df)[i] <- colnames(muc.df)[i]
}
muc.sum.df <- data.frame(t(muc.sum.df))
colnames(muc.sum.df) <- "Total_MucinDeg"
muc.sum.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
muc.sum.df$Season <- ordered(muc.sum.df$Season, levels=c("Summer", "Winter", "Spring"))


# Test normality
hist(muc.sum.df[,1])
qqnorm(muc.sum.df[,1])
qqline(muc.sum.df[,1])
shapiro.test(muc.sum.df[,1])
  # p-value = 0.979
  # Normal

# Test w/ ANOVA
summary(aov(Total_MucinDeg ~ Season, data = muc.sum.df))
  # p-value = 0.0263

# Posthoc test w/ Tukey's
TukeyHSD(aov(Total_MucinDeg ~ Season, data = muc.sum.df))
  # Winter-Summer = 0.3489136
  # Spring-Summer = 0.0223984*
  # Spring-Winter = 0.1447197


### Boxplot
ggplot(muc.sum.df, aes(x=Season, y=Total_MucinDeg, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(position=position_dodge(width = 0.2), size=2) +
  ylab("Normalized Counts of Mucin-degrading CAZymes") +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_y_continuous(breaks = c(3400, 3600, 3800, 4000, 4200), limits=c(3400, 4200)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


### DESeq2
dbcan.muc <- subset_taxa(dbcan.phy, Family == "GH2" | Family == "GH3" | 
                           Family == "GH4" | Family == "GH16" | Family == "GH18" |
                           Family == "GH20" | Family == "GH27" | Family == "GH29" |
                           Family == "GH31" | Family == "GH33" | Family == "GH35" |
                           Family == "GH36" | Family == "GH38" | Family == "GH42" |
                           Family == "GH67" | Family == "GH76" | Family == "GH84" |
                           Family == "GH85" | Family == "GH89" | Family == "GH92" |
                           Family == "GH95" | Family == "GH97" | Family == "GH98" |
                           Family == "GH101" | Family == "GH109" |
                           Family == "GH110" | Family == "GH112" |
                           Family == "GH123" | Family == "GH125" |
                           Family == "GH129" | Family == "GH130" | 
                           Family == "GH163")




dbcan.muc.dds <- phyloseq_to_deseq2(dbcan.muc, ~Season)
  # Design variable must be unordered otherwise you get an error
dbcan.muc.dds$Season <- factor(dbcan.muc.dds$Season, levels=c("Summer", "Winter", "Spring"))
dbcan.muc.dds <- dbcan.muc.dds[rowSums(counts(dbcan.muc.dds)) > 1,]
dbcan.muc.dds <- DESeq(dbcan.muc.dds)

# Pull out results from pairwise comparisons
dbcan.muc.sw <- results(dbcan.muc.dds, contrast=c("Season", "Summer", "Winter"))
dbcan.muc.sw.sig <- dbcan.muc.sw[which(dbcan.muc.sw$padj < 0.05),]
  # None
dbcan.muc.sp <- results(dbcan.muc.dds, contrast=c("Season", "Summer", "Spring"))
dbcan.muc.sp.sig <- dbcan.muc.sp[which(dbcan.muc.sp$padj < 0.05),]
  # None
dbcan.muc.wp <- results(dbcan.muc.dds, contrast=c("Season", "Winter", "Spring"))
dbcan.muc.wp.sig <- dbcan.muc.wp[which(dbcan.muc.wp$padj < 0.05),]
dbcan.muc.wp.sig[which(dbcan.muc.wp.sig$log2FoldChange > 0),]
  # Enriched in Winter compared to Spring (positive log2FoldChange)
    # GH20, GH84
dbcan.muc.wp.sig[which(dbcan.muc.wp.sig$log2FoldChange < 0),]
  # Enriched in Spring compared to Winter (negative log2FoldChange)
    # GH3, GH36, GH42, GH129
```



### Mucin - Proportion mucin-degrading genes from ORFs
```{r}
prodigalCounts <- read.csv('mucin/prodigalCounts.csv', row.names=1)
prodigalCounts <- as.matrix(prodigalCounts)
# Test normality
hist(prodigalCounts[3,])
qqnorm(prodigalCounts[3,])
qqline(prodigalCounts[3,])
shapiro.test(prodigalCounts[3,])
  # p-value = 0.05926
  # Normal
# Format for ANOVA
prodigalCounts <- read.csv('mucin/prodigalCounts.csv', row.names=1)
prodigalCounts <- t(prodigalCounts)
prodigalCounts <- data.frame(prodigalCounts)
prodigalCounts$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
prodigalCounts$Season <- ordered(prodigalCounts$Season, levels=c("Summer", "Winter", "Spring"))
colnames(prodigalCounts) <- c("Total_ORFs", "Total_MucinGenes", "MucinGenePercentage", "Season")
# Test w/ ANOVA
summary(aov(MucinGenePercentage ~ Season, data = prodigalCounts))
  # p-value = 0.224
### Dot plot
#tiff("mucin.prop.tiff", width=5, height=4, units="in", res= 300)
ggplot(prodigalCounts, aes(x=Season, y=MucinGenePercentage, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, stackratio=1.15) +
  ylab("% ORFs annotated as Mucin-Degrading Gene (%)") +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_y_continuous(breaks = c(0.06, 0.07, 0.08, 0.09), limits=c(0.06, 0.09)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"))
#dev.off()
```

### Mucin - Create phyloseq object (DON'T RUN!!!)
```{r}
# Load data
muc.otu <- read.csv('mucin/mucinCount.csv', row.names=1)
colnames(muc.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
muc.tax <- read.csv('mucin/mucinClassification.csv', row.names=1)
muc.tax <- tax_table(muc.tax)
colnames(muc.tax) <- c("GH_Class", "GH_Family", "EC1", "EC2", "EC3", "EC4", "FullName")
taxa_names(muc.tax) <- muc.tax[,7]
meta <- read.csv('dbcan/dbcan.spades.metadata.csv', row.names=1)


# Remove enzyme genes that appear in only 1 sample
muc.rem <- list()
for(i in 1:nrow(muc.otu)){
  empty <- length(which(muc.otu[i,] == 0))
    # Identifies # of samples w/o CAZyme
  if(empty > 7){
    # If CAZyme appears in only 1 sample
    muc.rem <- append(muc.rem, i)
      # Create list of CAZymes that appear in only 1 sample
  }
}
muc.rem.row <- as.numeric(muc.rem)
  # Convert list to numeric

# Remove CAZymes that appear in only 1 sample
muc.otu.rem <- muc.otu[-muc.rem.row,]
  # 8 enzyme genes: GH16_3.2.1.23, GH16_3.2.1.103, GH4_3.2.1.24, 3.2.1.1.2, 3.1.6.3, 3.1.6.4, 3.1.6.8, 3.1.6.14

# Convert trimmed CAZyme table to otu_table
muc.otu.rem.tab <- otu_table(muc.otu.rem, taxa_are_rows = T)

# Create phyloseq object
mucin.phy <- merge_phyloseq(muc.otu.rem.tab, muc.tax, sample_data(meta))
#save(mucin.phy, file = "mucin.phy.RData")

# Normalized Counts
muc.cut.otu <- data.frame(otu_table(mucin.phy))
mucin.dds <- DESeqDataSetFromMatrix(countData = muc.cut.otu, colData = meta, design = ~ Season)
mucin.dds <- estimateSizeFactors(mucin.dds)
mucin.norm <- counts(mucin.dds, normalized=T)
write.csv(mucin.norm, file = "mucin/mucin.normalized.counts.csv")
mucin.norm <- read.csv('mucin/mucin.normalized.counts.csv', row.names=1)
muc.norm.otu <- otu_table(mucin.norm, taxa_are_rows=T)
sample_names(muc.norm.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
muc.norm.phy <- merge_phyloseq(muc.norm.otu, sample_data(mucin.phy), tax_table(mucin.phy))
#save(muc.norm.phy, file = "muc.norm.phy.RData")
```
### Mucin - Load Data
```{r}
load("mucin.phy.RData")
load("muc.norm.phy.RData")
meta <- read.csv('dbcan/dbcan.spades.metadata.csv', row.names=1)
```
### Mucin - Count unique mucin-deg genes
```{r}
# Subset out samples by season
phy.sum <- subset_samples(mucin.phy, Season == "Summer")
phy.win <- subset_samples(mucin.phy, Season == "Winter")
phy.spr <- subset_samples(mucin.phy, Season == "Spring")

# Pull out unique muc-deg gene annotations in each season and order alphabetically
sum.gene <- get_taxa_unique(phy.sum, "FullName")
sum.gene <- sort(sum.gene)
win.gene <- get_taxa_unique(phy.win, "FullName")
win.gene <- sort(win.gene)
spr.gene <- get_taxa_unique(phy.spr, "FullName")
spr.gene <- sort(spr.gene)

# Count unique annotations
length(sum.gene)
  # 20
length(win.gene)
  # 21
length(spr.gene)
  # 21

```

### Mucin - Enzyme bar plots
```{r}
# Summarize data
mucin.df <- psmelt(muc.norm.phy)
mucin.sum <- mucin.df %>%
  group_by(FullName, Season) %>%
  summarize(Mean = mean(Abundance),
            SD= sd(Abundance),
            SE = se(Abundance))
mucin.sum$FullName = ordered(mucin.sum$FullName, c("GH2_3.2.1.23", "GH2_3.2.1.25", "GH3_3.2.1.52", "GH4_3.2.1.22", "GH20_3.2.1.52", "GH27_3.2.1.22", "GH29_3.2.1.51", "GH31_3.2.1.20", "GH35_3.2.1.23", "GH36_3.2.1.22", "GH38_3.2.1.24", "GH42_3.2.1.23", "GH67_3.2.1.139", "GH84_3.2.1.169", "GH95_3.2.1.51", "GH101_3.2.1.97", "GH110_3.2.1.22", "GH112_2.4.1.211", "GH130_2.4.1.281", "GH130_2.4.1.320", "4.1.3.3"))
mucin.sum$Season = ordered(mucin.sum$Season, levels=c("Summer", "Winter", "Spring"))


# Plot barplot
#tiff("mucin.family.tiff", width=33, height=7, units="in", res= 300)
ggplot(mucin.sum, aes(x=Season, y=Mean, fill=Season)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=Mean+SE, ymin=Mean-SE), width=0.25) +
  #scale_y_continuous(limits=c(0,2e-2)) +
  facet_grid(. ~ FullName) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  xlab("Mucin-Degrading Gene Classification") +
  ylab("Mean Normalized Counts") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_text(margin = margin(t = 15)))
#dev.off()

```

### Mucin - Create DESeq Object
```{r}
# https://www.bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html
# https://compbiocore.github.io/deseq-workshop-1/assets/deseq_workshop_1.html
# Use UN-NORMALIZED data!!!
  # DESeq accounts for library size


### Test DESeq2 to determine fit type
# https://support.bioconductor.org/p/81094/
#mucin.dds <- phyloseq_to_deseq2(mucin.phy, ~Season)
#mucin.dds$Season <- factor(mucin.dds$Season, levels=c("Summer", "Winter", "Spring"))
#mucin.dds <- mucin.dds[rowSums(counts(mucin.dds)) > 1,]
#mucin.local <- DESeq(mucin.dds, fitType = "local")
#mucin.par <- DESeq(mucin.dds, fitType = "parametric")
#mad(log(mcols(mucin.local)$dispGeneEst) - log(mcols(mucin.local)$dispFit))
  # 0.8725067
#mad(log(mcols(mucin.par)$dispGeneEst) - log(mcols(mucin.par)$dispFit))
  # 0.8725067
# No difference in fit type, but DESeq says local is better



### Convert phyloseq object to deseq2 object
mucin.dds <- phyloseq_to_deseq2(mucin.phy, ~Season)
  # Design variable must be unordered otherwise you get an error
mucin.dds$Season <- factor(mucin.dds$Season, levels=c("Summer", "Winter", "Spring"))
mucin.dds <- mucin.dds[rowSums(counts(mucin.dds)) > 1,]


# DESeq DataStructure for analyses
mucin.dds <- DESeq(mucin.dds)
  # DESeq choose fitType = local

# Hellinger-transform data for visualizations
muc.hell <- hellinger(t(assay(mucin.dds)))
```

### Mucin - DESeq - find overrep genes
```{r}
# Pull out results from pairwise comparison
mucin.sw <- results(mucin.dds, contrast=c("Season", "Summer", "Winter"))
mucin.sw.sig <- mucin.sw[which(mucin.sw$padj < 0.05),]
  # None
mucin.sp <- results(mucin.dds, contrast=c("Season", "Summer", "Spring"))
mucin.sp.sig <- mucin.sp[which(mucin.sp$padj < 0.05),]
  # Enriched in Spring compared to Summer (negative log2FoldChange)
    # GH112_2.4.1.211
mucin.wp <- results(mucin.dds, contrast=c("Season", "Winter", "Spring"))
mucin.wp.sig <- mucin.wp[which(mucin.wp$padj < 0.05),]
mucin.wp.sig[which(mucin.wp.sig$log2FoldChange > 0),]
  # Enriched in Winter compared to Spring (positive log2FoldChange)
    # GH110_3.2.1.22, GH84_3.2.1.169
mucin.wp.sig[which(mucin.wp.sig$log2FoldChange < 0),]
  # Enriched in Spring compared to Winter (negative log2FoldChange)
    # GH36_3.2.1.22, GH42_3.2.1.23
```




### Mucin - Heatmap of normalized counts
```{r}
muc.hell.otu <- otu_table(t(muc.hell), taxa_are_rows = T)
colnames(muc.hell.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744",
                                "3772", "3773" , "3775")
muc.sig <- merge_phyloseq(muc.hell.otu, tax_table(mucin.phy),
                          sample_data(mucin.phy))
mucin.sig <- subset_taxa(muc.sig, FullName == "GH112_2.4.1.211" |
                           FullName == "GH36_3.2.1.22" |
                           FullName == "GH42_3.2.1.23" |
                           FullName == "GH84_3.2.1.169" |
                           FullName == "GH110_3.2.1.22")
                           
  


#tiff("mucin.heatmap.tiff", width=15, height=7, units="in", res=300)
plot_heatmap(mucin.sig, sample.label = "Season", sample.order = c("3715", "3717", "3744", "3723", "3733", "3772", "3734", "3773", "3775"), taxa.order = c("GH110_3.2.1.22", "GH84_3.2.1.169", "GH42_3.2.1.23", "GH36_3.2.1.22", "GH112_2.4.1.211")) +
  geom_tile(colour="gray40") +
  geom_text(aes(label=sprintf("%0.2f", round(Abundance, digits=4))), size = 7) +
  scale_x_discrete(position = "top", labels=c("Summer", "Summer", "Summer", "Winter", "Winter", "Winter", "Spring", "Spring", "Spring")) +
  xlab("Season\n\n") +
  ylab("Mucin-Degrading Enzyme Gene\n\n") +
  scale_fill_gradientn(name=expression("Hellinger-\nTransformed\nNormalized\nCounts\n"), limits=c(0.11, 0.48),
                       breaks=c(0.11, 0.18, 0.25, 0.33, 0.40, 0.48), 
                       labels=c("0.11", "0.18", "0.25", "0.33", "0.40", "0.48"),
                       colours = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976",
                                   "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c",
                                   "#bd0026")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=20),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=20, face="bold"),
        axis.title.y = element_text(size=20, face="bold"),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20)) +
  guides(fill = guide_colorbar(barheight = unit(5,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()


```






### Mucin - DESeq sample dist heatmap / dendrogram
```{r}
# https://www.bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#exploring-and-exporting-results
# http://bioconductor.org/packages/devel/workflows/vignettes/rnaseqGene/inst/doc/rnaseqGene.html

muc.dist <- dist(muc.hell, method = "euclidean")
muc.dist.matrix <- as.matrix(muc.dist)
rownames(muc.dist.matrix) <- muc.transform$Season
colnames(muc.dist.matrix) <- muc.transform$Season

# Heatmap
#pheatmap(muc.dist.matrix, clustering_distance_rows = muc.dist, clustering_distance_cols = muc.dist,
         col = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c",
                 "#bd0026", "#800026"))

# Dendrogram
muc.hclust <- hclust(muc.dist, method = "average")
muc.den <- as.dendrogram(muc.hclust)
muc.den.data <- dendro_data(muc.den, type="rectangle")
muc.den.data$labels[,3] <- c("Spring", "Spring", "Summer", "Summer", "Summer", "Spring", "Winter", "Winter", "Winter")
muc.den.data$labels[,3] <- ordered(muc.den.data$labels[,3], levels=c("Summer", "Winter", "Spring"))

#tiff("mucin.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(muc.den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = muc.den.data$labels, aes(x, y, label=label, colour=label, fontface = "bold"),
            hjust=0, size=5) +
  ylab("Kendall Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("darkgoldenrod3", "dodgerblue3", "green4")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()

```

### Mucin - DESeq sample dist PCA & PERMANOVA
```{r}
muc.pcoa <- pcoa(muc.dist)
  # Total var explained = 71.8
mucin.phy.ord <- mucin.phy
sample_data(mucin.phy.ord)$Season <- ordered(sample_data(mucin.phy.ord)$Season, levels = c("Summer", "Winter", "Spring"))

#tiff("mucin.pcoa.tiff", width=8, height=6, units="in", res=300)
plot_ordination(physeq = mucin.phy.ord, ordination = muc.pcoa, axes = c(1,2),
                color = "Season") +
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Kendall Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))
#dev.off()


### Test normality
hist(muc.dist)
qqnorm(muc.dist)
qqline(muc.dist)
shapiro.test(muc.dist)
  # p-value = 0.4856
  # Normal


### Run PERMANOVA on DESEq Kendall distance
adonis(muc.dist ~ Season, data=meta, permutations = 99999)
  # p-value = 0.00358
beta.tax = betadisper(d=muc.dist, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.598



### Pairwise PERMANOVA Comparisons
muc.dist.matrix <- as.matrix(muc.dist)
muc.dist.df <- data.frame(muc.dist.matrix)

# Summer vs. Winter
muc.sw.dist.df <- muc.dist.df[,-5]
muc.sw.dist.df <- muc.sw.dist.df[,-7:-8]
muc.sw.dist.df <- muc.sw.dist.df[-5,]
muc.sw.dist.df <- muc.sw.dist.df[-7:-8,]
muc.sw.dist <- as.dist(muc.sw.dist.df)
meta.sw <- meta[-which(meta$Season == "Spring"),]
adonis(muc.sw.dist ~ Season, data=meta.sw, permutations= 99999)
  # p-value = 0.1

# Summer vs. Spring
muc.sp.dist.df <- muc.dist.df[,-3:-4]
muc.sp.dist.df <- muc.sp.dist.df[,-5]
muc.sp.dist.df <- muc.sp.dist.df[-3:-4,]
muc.sp.dist.df <- muc.sp.dist.df[-5,]
muc.sp.dist <- as.dist(muc.sp.dist.df)
meta.sp <- meta[-which(meta$Season == "Winter"),]
adonis(muc.sp.dist ~ Season, data=meta.sp, permutations= 99999)
  # p-value = 0.1

# Spring vs. Winter
muc.wp.dist.df <- muc.dist.df[,-3:-4]
muc.wp.dist.df <- muc.wp.dist.df[,-5]
muc.wp.dist.df <- muc.wp.dist.df[-3:-4,]
muc.wp.dist.df <- muc.wp.dist.df[-5,]
muc.wp.dist <- as.dist(muc.wp.dist.df)
meta.wp <- meta[-which(meta$Season == "Summer"),]
adonis(muc.wp.dist ~ Season, data=meta.wp, permutations= 99999)
  # p-value = 0.1


```
