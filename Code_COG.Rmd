---
title: "COG Code"
author: "Edna Chiang"
date: "2/9/2021"
output: html_document
---

### Load Libraries
```{r}
library('readr')
library('pgirmess')
library('ggplot2')
library('grid')
library('phyloseq')
library('DESeq2')
library('phangorn')
library('vegan')
library('pheatmap')
library('RColorBrewer')
library('gplots')
library('tidyr')
library('dplyr')
library('stringr')
library('lme4')
library('picante')
library('ggdendro')
library('fitdistrplus')
library('amap')
library('labdsv')
library('NBPSeq')
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/misc.R')
source('scripts/simper.R')
source('scripts/pairwise.adonis.R')
```

### COG - Create phyloseq objects (DON'T RUN!)
```{r}
### Count-level ###

# Load data
cog.counts <- read.csv('cog/cog.counts.tab', header = T, sep = "\t", row.names = 1)


# Identify COGs that appear in only 1 sample
cog.rem <- list()
for(i in 1:nrow(cog.counts)){
  empty <- length(which(cog.counts[i,] == 0))
    # Identifies number of samples without COG
  if(empty > 7){
    # If COG appears in only 1 sample
    cog.rem <- append(cog.rem, i)
      # Create list of COGs that appear in only 1 sample
  }
}
cog.rem.row <- as.numeric(cog.rem)
  # Convert list to numeric


# Pull out removed COGs, their category classification, and their sole sample so I can update the COG category counts
cog.rem.names <- rownames(cog.counts[cog.rem.row,])
cog.cat <- read.csv('cog/cog.classifications.tab', header = T, sep = "\t")
cog.rem.cat <- data.frame(matrix(nrow = length(cog.rem.row), ncol = 3))
colnames(cog.rem.cat) <- c("COG", "Category", "Sample")
for(j in 1:length(cog.rem.names)){
  matchName = which(cog.cat[,1] == cog.rem.names[j])
  cog.rem.cat[j,1:2] <- cog.cat[matchName,1:2]
  
  matchSamp = which(rownames(cog.counts) == cog.rem.names[j])
  yes <- which(cog.counts[matchSamp,] != 0)
  cog.rem.cat[j,3] <- substr(colnames(cog.counts)[yes], 2, 5)
}

cog.rem.cat.counts <- data.frame(matrix(nrow = 25, ncol = 11))
colnames(cog.rem.cat.counts) <- c("Category", "Count", "3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
cog.rem.cat.counts[,1] <- c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "Y", "Z")
cog.rem.cat.counts[,2:11] <- 0
for(k in 1:nrow(cog.rem.cat)){
  match <- length(which(grepl(cog.rem.cat[k,2], cog.rem.cat.counts[,1])))

  if(match > 0){
    matchRow <- which(grepl(cog.rem.cat[k,2], cog.rem.cat.counts[,1]))
    cog.rem.cat.counts[matchRow, 2] <- cog.rem.cat.counts[matchRow, 2] + 1
    sampCol <- which(colnames(cog.rem.cat.counts) == cog.rem.cat$Sample[k])
    cog.rem.cat.counts[matchRow, sampCol] <- cog.rem.cat.counts[matchRow, sampCol] + 1
  }
}


# Remove COGs that appear in only 1 sample
cog.rem <- cog.counts[-cog.rem.row,]
colnames(cog.rem) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")

# Format data
cog.df <- data.frame(t(cog.rem))
rownames(cog.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
cog.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
cog.df$Season <- ordered(cog.df$Season, levels=c("Summer", "Winter", "Spring"))

# Load COG "tax_table"
cog.cat <- read.csv('cog/cog.classifications.tab', header = T, sep = "\t")
cog.tax <- data.frame(cog.cat[,-2:-3])

# Prepare phyloseq object inputs
cog.otu <- otu_table(cog.rem, taxa_are_rows = T)
cog.tax <- tax_table(cog.tax)
taxa_names(cog.tax) <- cog.tax[,1]
meta <- read.csv('metadata.csv', row.names=1)

# Create phyloseq object
cog.phy <- merge_phyloseq(cog.otu, cog.tax, sample_data(meta))
colnames(tax_table(cog.phy)) <- "COG"
#save(cog.phy, file = "cog.phy.Rdata")



### Category-level ###

# Load data
cog.cat <- read.csv('cog/cog.category.csv', header = T, row.names = 1)
cog.cat.rem <- cog.rem.cat.counts[,3:11]
cog.cat.trim <- cog.cat - cog.cat.rem
cog.cat.otu <- otu_table(cog.cat.trim, taxa_are_rows = T)
colnames(cog.cat.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")


# Create phyloseq object
cog.cat.tax <- data.frame(rownames(cog.cat.trim))
rownames(cog.cat.tax) <- cog.cat.tax[,1]
colnames(cog.cat.tax) <- "Category"
cog.cat.tax <- tax_table(cog.cat.tax)
taxa_names(cog.cat.tax) <- cog.cat.tax[,1]
colnames(cog.cat.tax) <- "Category"
cog.cat.phy <- merge_phyloseq(cog.cat.otu, cog.cat.tax, sample_data(meta))
#save(cog.cat.phy, file = "cog.cat.phy.Rdata")



### Category - Normalized Counts ###
cog.cat.dds <- phyloseq_to_deseq2(cog.cat.phy, ~Season)
cog.cat.dds <- estimateSizeFactors(cog.cat.dds)
cog.cat.norm <- counts(cog.cat.dds, normalized = T)
cog.cat.norm.phy <- merge_phyloseq(otu_table(cog.cat.norm, taxa_are_rows = T), tax_table(cog.cat.phy), sample_data(cog.cat.phy))
#save(cog.cat.norm.phy, file = "cog.cat.norm.phy.Rdata")




### Category - All Counts ###
cog.dds <- phyloseq_to_deseq2(cog.phy, ~Season)
cog.dds <- estimateSizeFactors(cog.dds)
cog.norm <- counts(cog.dds, normalized = T)
cog.norm.phy <- merge_phyloseq(otu_table(cog.norm, taxa_are_rows = T), tax_table(cog.phy), sample_data(cog.phy))
#save(cog.norm.phy, file = "cog.norm.phy.Rdata")
```
### COG - Load physeq objects
```{r}
load("cog.phy.Rdata")
load("cog.cat.phy.Rdata")
load("cog.cat.norm.phy.Rdata")
load("cog.norm.phy.Rdata")
meta <- read.csv('metadata.csv', row.names=1)
```


### COG - Calculate % ORFs classified to COG
```{r}
prodigalCounts <- read.csv('cog/prodigalCounts.csv', row.names = 1)
prodigalCounts <- as.matrix(prodigalCounts)

# Test normality
hist(prodigalCounts[3,])
qqnorm(prodigalCounts[3,])
qqline(prodigalCounts[3,])
shapiro.test(prodigalCounts[3,])
  # p-value = 0.108
  # Normal

# Format for ANOVA
prodigalCounts <- read.csv('cog/prodigalCounts.csv', row.names=1)
prodigalCounts <- t(prodigalCounts)
prodigalCounts <- data.frame(prodigalCounts)
prodigalCounts$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
prodigalCounts$Season <- ordered(prodigalCounts$Season, levels=c("Summer", "Winter", "Spring"))
prodigalCounts$Diet <- c("Feeding", "Feeding", "Fasting", "Fasting", "Feeding", "Feeding", "Fasting", "Feeding", "Feeding")
prodigalCounts$Diet <- ordered(prodigalCounts$Diet, levels=c("Feeding", "Fasting"))
colnames(prodigalCounts) <- c("Total_ORFs", "Total_COGs", "COGPercentage", "Season", "Diet")

# Test w/ ANOVA
summary(aov(COGPercentage ~ Season, data = prodigalCounts))
  # p-value = 0.634
summary(aov(COGPercentage ~ Diet, data = prodigalCounts))
  # p-value = 0.37

### Dot plot
#tiff("cog.prop.tiff", width=5, height=4, units="in", res= 300)
ggplot(prodigalCounts, aes(x=Season, y=COGPercentage, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, stackratio=1.15) +
  ylab("% ORFs annotated as COG (%)") +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_y_continuous(breaks = c(37, 40, 43, 46, 49), limits=c(37, 49)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"))
#dev.off()
```
### COG - Number of unique COGs
```{r}
phy.sum <- subset_samples(cog.phy, Season == "Summer")
phy.win <- subset_samples(cog.phy, Season == "Winter")
phy.spr <- subset_samples(cog.phy, Season == "Spring")


# Count # unique COGs in each season
sum.cog <- data.frame(otu_table(phy.sum))
sum.rem <- which(rowSums(sum.cog) == 0)
sum.cog <- sum.cog[-sum.rem,]
nrow(sum.cog)
  # 3673
win.cog <- data.frame(otu_table(phy.win))
win.rem <- which(rowSums(win.cog) == 0)
win.cog <- win.cog[-win.rem,]
nrow(win.cog)
  # 3544
spr.cog <- data.frame(otu_table(phy.spr))
spr.rem <- which(rowSums(spr.cog) == 0)
spr.cog <- spr.cog[-spr.rem,]
nrow(spr.cog)
  # 3698

```
### COG - General COG Stats
```{r}
# Load data
cog.stats <- read.csv('cog/cog.stats.csv', row.names = 1, header = T)
cog.stats <- as.matrix(cog.stats)

# Test normality - % COGs from ORFs
hist(cog.stats[3,])
qqnorm(cog.stats[3,])
qqline(cog.stats[3,])
shapiro.test(cog.stats[3,])
  # p-value = 0.108
  # Normal

# Test normality - Unique COGs
hist(cog.stats[4,])
qqnorm(cog.stats[4,])
qqline(cog.stats[4,])
shapiro.test(cog.stats[4,])
  # p-value = 0.1712
  # Normal

# Format for ANOVA
cog.stats <- data.frame(t(cog.stats))
rownames(cog.stats) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
cog.stats$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")

# Test w/ ANOVA
summary(aov(Prop_COGs ~ Season, data = cog.stats))
  # p-value = 0.634
summary(aov(Unique_COGs ~ Season, data = cog.stats))
  # p-value = 0.51

ggplot(cog.stats, aes(x=Season, y=Prop_COGs, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, stackratio=1.15) +
  ylab("% ORFs annotated as COG (%)") +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_y_continuous(breaks = c(37, 40, 43, 46, 49), limits=c(37, 49)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"))

ggplot(cog.stats, aes(x=Season, y=Unique_COGs, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, stackratio=1.15) +
  ylab("Unique COGs") +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_y_continuous(breaks = c(3200, 3400, 3600), limits=c(3200, 3600)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"))
```

### COG Category - Create DESeq object
```{r}
# https://www.bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html
# https://compbiocore.github.io/deseq-workshop-1/assets/deseq_workshop_1.html
# https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html

### Convert phyloseq object to deseq2 object
cog.cat.dds <- phyloseq_to_deseq2(cog.cat.phy, ~Season)
  # Design variable must be unordered otherwise you get an error
cog.cat.dds$Season <- factor(cog.cat.dds$Season, levels=c("Summer", "Winter", "Spring"))

# DESeq DataStructure for analyses
cog.cat.dds <- DESeq(cog.cat.dds, fitType = 'local')

# Hellinger-transformed data for visualizations
cog.cat.hell <- hellinger(t(assay(cog.cat.dds)))
```

### COG Category - Clustering
```{r}
cog.cat.dist <- dist(cog.cat.hell, method = "euclidean")
cog.cat.dist.matrix <- as.matrix(cog.cat.dist)
rownames(cog.cat.dist.matrix) <- meta$Season
colnames(cog.cat.dist.matrix) <- meta$Season


# Dendrogram
cog.cat.hclust <- hclust(cog.cat.dist, method = "average")
cog.cat.den <- as.dendrogram(cog.cat.hclust)
cog.cat.den.data <- dendro_data(cog.cat.den, type = "rectangle")
cog.cat.den.data$labels[,3] <- c("Summer", "Winter", "Winter", "Winter", "Summer", "Spring", "Spring", "Spring", "Summer")
cog.cat.den.data$labels[,3] <- ordered(cog.cat.den.data$labels[,3], levels=c("Summer", "Winter", "Spring"))


#tiff("cog.cat.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(cog.cat.den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = cog.cat.den.data$labels, aes(x, y, label=label, colour=label, fontface = "bold"),
            hjust=0, size=5) +
  ylab("Hellinger Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("darkgoldenrod3", "dodgerblue3", "green4")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()
```


### COG Category - PCoA & PERMANOVA
```{r}
cog.cat.pcoa <- pcoa(cog.cat.dist)
  # Total variation explained = 71.5%
cog.cat.phy.ord <- cog.cat.norm.phy
sample_data(cog.cat.phy.ord)$Season <- ordered(sample_data(cog.cat.phy.ord)$Season, levels = c("Summer", "Winter", "Spring"))
#tiff("cog.cat.pcoa.tiff", width=7, height=5, units="in", res=300)
plot_ordination(physeq = cog.cat.phy.ord, ordination = cog.cat.pcoa, axes = c(1,2),
                color = "Season") +
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Hellinger Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))
#dev.off()
### Run PERMANOVA on Hellinger distance
adonis(cog.cat.dist ~ Season, data=meta, permutations = 99999)
  # p-value = 0.1306
beta.tax = betadisper(d=cog.cat.dist, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.27
```

### COG All - DESeq
```{r}
### Convert phyloseq object to deseq2 object
cog.dds <- phyloseq_to_deseq2(cog.phy, ~Season)
cog.dds$Season <- factor(cog.dds$Season, levels = c("Summer", "Winter", "Spring"))

# DESeq DataStructure for analyses
cog.dds <- DESeq(cog.dds)

# Hellinger-transformed data for visualizations
cog.hell <- hellinger(t(assay(cog.dds)))
```

### COG All - Clustering
```{r}
cog.dist <- dist(cog.hell, method = "euclidean")
cog.dist.matrix <- as.matrix(cog.dist)
rownames(cog.dist.matrix) <- meta$Season
colnames(cog.dist.matrix) <- meta$Season


# Dendrogram
cog.hclust <- hclust(cog.dist, method = "average")
cog.den <- as.dendrogram(cog.hclust)
cog.den.data <- dendro_data(cog.den, type = "rectangle")
cog.den.data$labels[,3] <- c("Summer", "Winter", "Winter", "Winter", "Summer", "Spring", "Spring", "Spring", "Summer")
cog.den.data$labels[,3] <- ordered(cog.den.data$labels[,3], levels=c("Summer", "Winter", "Spring"))


#tiff("cog.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(cog.den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = cog.den.data$labels, aes(x, y, label=label, colour=label, fontface = "bold"),
            hjust=0, size=5) +
  ylab("Hellinger Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("darkgoldenrod3", "dodgerblue3", "green4")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()
```


### COG All - PCoA & PERMANOVA
```{r}
cog.pcoa <- pcoa(cog.dist)
  # Total variation explained = 62.4%
cog.phy.ord <- cog.norm.phy
sample_data(cog.phy.ord)$Season <- ordered(sample_data(cog.phy.ord)$Season, levels = c("Summer", "Winter", "Spring"))



#tiff("cog.pcoa.tiff", width=7, height=5, units="in", res=300)
plot_ordination(physeq = cog.phy.ord, ordination = cog.pcoa, axes = c(1,2),
                color = "Season") +
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Hellinger Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))
#dev.off()




### Run PERMANOVA on Hellinger distance
adonis(cog.dist ~ Season, data=meta, permutations = 99999)
  # p-value = 0.02154
beta.tax = betadisper(d=cog.dist, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.731



### Pairwise PERMANOVA Comparisons
cog.dist.matrix <- as.matrix(cog.dist)
cog.dist.df <- data.frame(cog.dist.matrix)

# Summer vs. Winter
cog.sw.dist.df <- cog.dist.df[,-5]
cog.sw.dist.df <- cog.sw.dist.df[,-7:-8]
cog.sw.dist.df <- cog.sw.dist.df[-5,]
cog.sw.dist.df <- cog.sw.dist.df[-7:-8,]
cog.sw.dist <- as.dist(cog.sw.dist.df)
meta.sw <- meta[-which(meta$Season == "Spring"),]
adonis(cog.sw.dist ~ Season, data=meta.sw, permutations= 99999)
  # p-value = 0.2

# Summer vs. Spring
cog.sp.dist.df <- cog.dist.df[,-3:-4]
cog.sp.dist.df <- cog.sp.dist.df[,-5]
cog.sp.dist.df <- cog.sp.dist.df[-3:-4,]
cog.sp.dist.df <- cog.sp.dist.df[-5,]
cog.sp.dist <- as.dist(cog.sp.dist.df)
meta.sp <- meta[-which(meta$Season == "Winter"),]
adonis(cog.sp.dist ~ Season, data=meta.sp, permutations= 99999)
  # p-value = 0.2

# Spring vs. Winter
cog.wp.dist.df <- cog.dist.df[,-3:-4]
cog.wp.dist.df <- cog.wp.dist.df[,-5]
cog.wp.dist.df <- cog.wp.dist.df[-3:-4,]
cog.wp.dist.df <- cog.wp.dist.df[-5,]
cog.wp.dist <- as.dist(cog.wp.dist.df)
meta.wp <- meta[-which(meta$Season == "Summer"),]
adonis(cog.wp.dist ~ Season, data=meta.wp, permutations= 99999)
  # p-value = 0.2
```

### COG All - DESeq - find overrep genes
```{r}
# Pull out results from pairwise comparison
cog.sw <- results(cog.dds, contrast = c("Season", "Summer", "Winter"))
cog.sw.sig <- cog.sw[which(cog.sw$padj < 0.05),]
cog.sw.sig[which(cog.sw.sig$log2FoldChange > 0),]
  # Enriched in Summer compared to Winter (positive log2FoldChange)
    # COG2207, COG3345, COG3507, COG3693, COG3866, COG3940
cog.sw.sig[which(cog.sw.sig$log2FoldChange < 0),]
  # Enriched in Winter compared to Summer (negative log2FoldChange)
    # COG3246


cog.sp <- results(cog.dds, contrast = c("Season", "Summer", "Spring"))
cog.sp.sig <- cog.sp[which(cog.sp$padj < 0.05),]
  # Enriched in Summer compared to Spring (positive log2FoldChange)
    # COG0243, COG0437, COG0457, COG1240, COG1629, COG2825, COG2885


cog.wp <- results(cog.dds, contrast = c("Season", "Winter", "Spring"))
cog.wp.sig <- cog.wp[which(cog.wp$padj < 0.05),]
cog.wp.sig[which(cog.wp.sig$log2FoldChange > 0),]
  # Enriched in Winter compared to Spring (positive log2FoldChange)
    # COG0457, COG0760, COG0774, COG1452, COG1463, COG1629, COG2825, COG2885, COG3637, COG4775
cog.wp.sig[which(cog.wp.sig$log2FoldChange < 0),]
  # Enriched in Spring compared to Winter (negative log2FoldChange)
    # COG0004, COG0246, COG0395, COG0561, COG1026, COG1061, COG1070, COG1105, COG1131, COG1132, COG1136, COG1175, COG1472, COG1511, COG1609, COG1653, COG1874, COG1925, COG2182, COG2190, COG2207, COG2730, COG2972, COG3044, COG3345, COG3664, COG3693, COG3757, COG3866, COG3940, COG3973, COG4284, COG4485, COG4709, COG4753, COG5578

```




