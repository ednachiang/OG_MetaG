---
title: "COG Code"
author: "Edna Chiang"
date: "2/9/2021"
output: html_document
---

### Load Libraries
```{r}
library('readr')
library('pgirmess')
library('ggplot2')
library('grid')
library('phyloseq')
library('DESeq2')
library('phangorn')
library('vegan')
library('pheatmap')
library('RColorBrewer')
library('gplots')
library('tidyr')
library('dplyr')
library('stringr')
library('lme4')
library('picante')
library('ggdendro')
library('fitdistrplus')
library('amap')
library('labdsv')
library('NBPSeq')
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/misc.R')
source('scripts/simper.R')
source('scripts/pairwise.adonis.R')
```

### COG - Create phyloseq objects (DON'T RUN!)
```{r}
### Count-level ###

# Load data
cog.counts <- read.csv('cog/cog.counts.tab', header = T, sep = "\t", row.names = 1)


# Identify COGs that appear in only 1 sample
cog.rem <- list()
for(i in 1:nrow(cog.counts)){
  empty <- length(which(cog.counts[i,] == 0))
    # Identifies number of samples without COG
  if(empty > 7){
    # If COG appears in only 1 sample
    cog.rem <- append(cog.rem, i)
      # Create list of COGs that appear in only 1 sample
  }
}
cog.rem.row <- as.numeric(cog.rem)
  # Convert list to numeric


# Pull out removed COGs, their category classification, and their sole sample so I can update the COG category counts
cog.rem.names <- rownames(cog.counts[cog.rem.row,])
cog.cat <- read.csv('cog/cog.classifications.tab', header = T, sep = "\t")
cog.rem.cat <- data.frame(matrix(nrow = length(cog.rem.row), ncol = 3))
colnames(cog.rem.cat) <- c("COG", "Category", "Sample")
for(j in 1:length(cog.rem.names)){
  matchName = which(cog.cat[,1] == cog.rem.names[j])
  cog.rem.cat[j,1:2] <- cog.cat[matchName,1:2]
  
  matchSamp = which(rownames(cog.counts) == cog.rem.names[j])
  yes <- which(cog.counts[matchSamp,] != 0)
  cog.rem.cat[j,3] <- substr(colnames(cog.counts)[yes], 2, 5)
}

cog.rem.cat.counts <- data.frame(matrix(nrow = 25, ncol = 11))
colnames(cog.rem.cat.counts) <- c("Category", "Count", "3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
cog.rem.cat.counts[,1] <- c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "Y", "Z")
cog.rem.cat.counts[,2:11] <- 0
for(k in 1:nrow(cog.rem.cat)){
  match <- length(which(grepl(cog.rem.cat[k,2], cog.rem.cat.counts[,1])))

  if(match > 0){
    matchRow <- which(grepl(cog.rem.cat[k,2], cog.rem.cat.counts[,1]))
    cog.rem.cat.counts[matchRow, 2] <- cog.rem.cat.counts[matchRow, 2] + 1
    sampCol <- which(colnames(cog.rem.cat.counts) == cog.rem.cat$Sample[k])
    cog.rem.cat.counts[matchRow, sampCol] <- cog.rem.cat.counts[matchRow, sampCol] + 1
  }
}


# Remove COGs that appear in only 1 sample
cog.rem <- cog.counts[-cog.rem.row,]
colnames(cog.rem) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")

# Format data
cog.df <- data.frame(t(cog.rem))
rownames(cog.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
cog.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
cog.df$Season <- ordered(cog.df$Season, levels=c("Summer", "Winter", "Spring"))

# Load COG "tax_table"
cog.cat <- read.csv('cog/cog.classifications.tab', header = T, sep = "\t")
cog.tax <- data.frame(cog.cat[,-2:-3])

# Prepare phyloseq object inputs
cog.otu <- otu_table(cog.rem, taxa_are_rows = T)
cog.tax <- tax_table(cog.tax)
taxa_names(cog.tax) <- cog.tax[,1]
meta <- read.csv('metadata.csv', row.names=1)

# Create phyloseq object
cog.phy <- merge_phyloseq(cog.otu, cog.tax, sample_data(meta))
colnames(tax_table(cog.phy)) <- "COG"
#save(cog.phy, file = "cog.phy.Rdata")



### Category-level ###

# Load data
cog.cat <- read.csv('cog/cog.category.csv', header = T, row.names = 1)
cog.cat.rem <- cog.rem.cat.counts[,3:11]
cog.cat.trim <- cog.cat - cog.cat.rem
cog.cat.otu <- otu_table(cog.cat.trim, taxa_are_rows = T)
colnames(cog.cat.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")


# Create phyloseq object
cog.cat.tax <- data.frame(rownames(cog.cat.trim))
rownames(cog.cat.tax) <- cog.cat.tax[,1]
colnames(cog.cat.tax) <- "Category"
cog.cat.tax <- tax_table(cog.cat.tax)
taxa_names(cog.cat.tax) <- cog.cat.tax[,1]
colnames(cog.cat.tax) <- "Category"
cog.cat.phy <- merge_phyloseq(cog.cat.otu, cog.cat.tax, sample_data(meta))
#save(cog.cat.phy, file = "cog.cat.phy.Rdata")



### Category - Normalized Counts ###
cog.cat.dds <- phyloseq_to_deseq2(cog.cat.phy, ~Season)
cog.cat.dds <- estimateSizeFactors(cog.cat.dds)
cog.cat.norm <- counts(cog.cat.dds, normalized = T)
cog.cat.norm.phy <- merge_phyloseq(otu_table(cog.cat.norm, taxa_are_rows = T), tax_table(cog.cat.phy), sample_data(cog.cat.phy))
#save(cog.cat.norm.phy, file = "cog.cat.norm.phy.Rdata")




### Category - All Counts ###
cog.dds <- phyloseq_to_deseq2(cog.phy, ~Season)
cog.dds <- estimateSizeFactors(cog.dds)
cog.norm <- counts(cog.dds, normalized = T)
cog.norm.phy <- merge_phyloseq(otu_table(cog.norm, taxa_are_rows = T), tax_table(cog.phy), sample_data(cog.phy))
#save(cog.norm.phy, file = "cog.norm.phy.Rdata")
```
### COG - Load physeq objects
```{r}
load("cog.phy.Rdata")
load("cog.cat.phy.Rdata")
load("cog.cat.norm.phy.Rdata")
load("cog.norm.phy.Rdata")
meta <- read.csv('metadata.csv', row.names=1)
```


### COG - Calculate % ORFs classified to COG
```{r}
prodigalCounts <- read.csv('cog/prodigalCounts.csv', row.names = 1)
prodigalCounts <- as.matrix(prodigalCounts)

# Test normality
hist(prodigalCounts[3,])
qqnorm(prodigalCounts[3,])
qqline(prodigalCounts[3,])
shapiro.test(prodigalCounts[3,])
  # p-value = 0.108
  # Normal

# Format for ANOVA
prodigalCounts <- read.csv('cog/prodigalCounts.csv', row.names=1)
prodigalCounts <- t(prodigalCounts)
prodigalCounts <- data.frame(prodigalCounts)
prodigalCounts$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
prodigalCounts$Season <- ordered(prodigalCounts$Season, levels=c("Summer", "Winter", "Spring"))
prodigalCounts$Diet <- c("Feeding", "Feeding", "Fasting", "Fasting", "Feeding", "Feeding", "Fasting", "Feeding", "Feeding")
prodigalCounts$Diet <- ordered(prodigalCounts$Diet, levels=c("Feeding", "Fasting"))
colnames(prodigalCounts) <- c("Total_ORFs", "Total_COGs", "COGPercentage", "Season", "Diet")

# Test w/ ANOVA
summary(aov(COGPercentage ~ Season, data = prodigalCounts))
  # p-value = 0.634
summary(aov(COGPercentage ~ Diet, data = prodigalCounts))
  # p-value = 0.37

### Dot plot
#tiff("cog.prop.tiff", width=5, height=4, units="in", res= 300)
ggplot(prodigalCounts, aes(x=Season, y=COGPercentage, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, stackratio=1.15) +
  ylab("% ORFs annotated as COG (%)") +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_y_continuous(breaks = c(37, 40, 43, 46, 49), limits=c(37, 49)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"))
#dev.off()
```
### COG - Number of unique COGs
```{r}
phy.sum <- subset_samples(cog.phy, Season == "Summer")
phy.win <- subset_samples(cog.phy, Season == "Winter")
phy.spr <- subset_samples(cog.phy, Season == "Spring")


# Count # unique COGs in each season
sum.cog <- data.frame(otu_table(phy.sum))
sum.rem <- which(rowSums(sum.cog) == 0)
sum.cog <- sum.cog[-sum.rem,]
nrow(sum.cog)
  # 3673
win.cog <- data.frame(otu_table(phy.win))
win.rem <- which(rowSums(win.cog) == 0)
win.cog <- win.cog[-win.rem,]
nrow(win.cog)
  # 3544
spr.cog <- data.frame(otu_table(phy.spr))
spr.rem <- which(rowSums(spr.cog) == 0)
spr.cog <- spr.cog[-spr.rem,]
nrow(spr.cog)
  # 3698

```
### COG - General COG Stats
```{r}
# Load data
cog.stats <- read.csv('cog/cog.stats.csv', row.names = 1, header = T)
cog.stats <- as.matrix(cog.stats)

# Test normality - % COGs from ORFs
hist(cog.stats[3,])
qqnorm(cog.stats[3,])
qqline(cog.stats[3,])
shapiro.test(cog.stats[3,])
  # p-value = 0.108
  # Normal

# Test normality - Unique COGs
hist(cog.stats[4,])
qqnorm(cog.stats[4,])
qqline(cog.stats[4,])
shapiro.test(cog.stats[4,])
  # p-value = 0.1712
  # Normal

# Format for ANOVA
cog.stats <- data.frame(t(cog.stats))
rownames(cog.stats) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
cog.stats$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")

# Test w/ ANOVA
summary(aov(Prop_COGs ~ Season, data = cog.stats))
  # p-value = 0.634
summary(aov(Unique_COGs ~ Season, data = cog.stats))
  # p-value = 0.51

ggplot(cog.stats, aes(x=Season, y=Prop_COGs, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, stackratio=1.15) +
  ylab("% ORFs annotated as COG (%)") +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_y_continuous(breaks = c(37, 40, 43, 46, 49), limits=c(37, 49)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"))

ggplot(cog.stats, aes(x=Season, y=Unique_COGs, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1, stackratio=1.15) +
  ylab("Unique COGs") +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_y_continuous(breaks = c(3200, 3400, 3600), limits=c(3200, 3600)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(face="bold"),
        strip.text.x = element_text(size=11),
        legend.title = element_text(face="bold"))
```

### COG Sporulation
```{r}
### Category D = Cell cycle control, cell division, chromosome partitioning
cog.cat.phy99 <- transform_sample_counts(cog.cat.phy, function(x){(x/sum(x))*100})

cog.d.phy <- subset_taxa(cog.cat.phy99, Category == "D")

cog.d.df <- data.frame(sample_data(cog.d.phy))
cog.d.df$RelAbund <- t(data.frame(otu_table(cog.d.phy)))

hist(cog.d.df$RelAbund)
qqnorm(cog.d.df$RelAbund)
qqline(cog.d.df$RelAbund)
shapiro.test(cog.d.df$RelAbund)
  # p-value = 0.3253
  # Normal
summary(aov(formula = RelAbund ~ Season, data=cog.d.df))
  # p-value = 0.769



### Subset out COGs specific to sporulation
#cog.spore <- c("COG0686","COG0784","COG1300","COG1774","COG1873","COG1994","COG2002","COG2359","COG2718","COG2719","COG3621","COG3679","COG3854","COG4326","COG4550","COG4862","COG5018","COG5801","COG5802","COG5803","COG5804","COG5805","COG5806","COG5807","COG5808","COG5809","COG5810","COG5811","COG5812","COG5813","COG5814","COG5815","COG5816","COG5817","COG5818","COG5819","COG5820","COG5821","COG5822","COG5823","COG5824","COG5825","COG5826","COG5827","COG5828","COG5829","COG5830","COG5831","COG5832","COG5833","COG5834","COG5835","COG5836","COG5837","COG5838","COG5839","COG5840","COG5841","COG5842","COG5843","COG5844","COG5845","COG5846","COG5847","COG5851","COG5866","COG5868","COG5870","COG5872","COG5873","COG5874","COG5875","COG5876","COG5878","COG5890","COG5895","COG5916","COG5917","COG5918","COG5919","COG5920","COG5921","COG5922","COG5923","COG5924","COG5925","COG5926")

cog.spore.phy <- subset_taxa(cog.norm.phy, COG == "COG0686" | COG == "COG0784" | COG == "COG1300" | COG == "COG1774" | COG == "COG1873" | COG == "COG1994" | COG == "COG2002" | COG == "COG2359" | COG == "COG2718" | COG == "COG2719" | COG == "COG3621" | COG == "COG3679" | COG == "COG3854" | COG == "COG4326" | COG == "COG4550" | COG == "COG4862" | COG == "COG5018" | COG == "COG5801" | COG == "COG5802" | COG == "COG5803" | COG == "COG5804" | COG == "COG5805" | COG == "COG5806" | COG == "COG5807" | COG == "COG5808" | COG == "COG5809" | COG == "COG5810" | COG == "COG5811" | COG == "COG5812" | COG == "COG5813" | COG == "COG5814" | COG == "COG5815" | COG == "COG5816" | COG == "COG5817" | COG == "COG5818" | COG == "COG5819" | COG == "COG5820" | COG == "COG5821" | COG == "COG5822" | COG == "COG5823" | COG == "COG5824" | COG == "COG5825" | COG == "COG5826" | COG == "COG5827" | COG == "COG5828" | COG == "COG5829" | COG == "COG5830" | COG == "COG5831" | COG == "COG5832" | COG == "COG5833" | COG == "COG5834" | COG == "COG5835" | COG == "COG5836" | COG == "COG5837" | COG == "COG5838" | COG == "COG5839" | COG == "COG5840" | COG == "COG5841" | COG == "COG5842" | COG == "COG5843" | COG == "COG5844" | COG == "COG5845" | COG == "COG5846" | COG == "COG5847" | COG == "COG5851" | COG == "COG5866" | COG == "COG5868" | COG == "COG5870" | COG == "COG5872" | COG == "COG5873" | COG == "COG5874" | COG == "COG5875" | COG == "COG5876" | COG == "COG5878" | COG == "COG5890" | COG == "COG5895" | COG == "COG5916" | COG == "COG5917" | COG == "COG5918" | COG == "COG5919" | COG == "COG5920" | COG == "COG5921" | COG == "COG5922" | COG == "COG5923" | COG == "COG5924" | COG == "COG5925" | COG == "COG5926")

# Format Data
spore.df <- psmelt(cog.spore.phy)


### Test -- NO SIG AFTER P ADJUST

use <- which(spore.df$COG == "COG0686")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.295

use <- which(spore.df$COG == "COG0784")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.329

use <- which(spore.df$COG == "COG1300")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.0243*

use <- which(spore.df$COG == "COG1774")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.0259*

use <- which(spore.df$COG == "COG1873")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.075

use <- which(spore.df$COG == "COG1994")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.28

use <- which(spore.df$COG == "COG2002")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.0398*

use <- which(spore.df$COG == "COG3679")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.0846

use <- which(spore.df$COG == "COG3854")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.0322*

use <- which(spore.df$COG == "COG4862")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.0524

use <- which(spore.df$COG == "COG5018")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.571

use <- which(spore.df$COG == "COG2359")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.821

use <- which(spore.df$COG == "COG3621")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.285

use <- which(spore.df$COG == "COG4550")
spore.test <- spore.df[use,]
summary(aov(formula = Abundance ~ Season, data=spore.test))
  # p-value = 0.619


# Adjust p
p.adjust(c(0.295,0.329,0.0243,0.0259,0.075,0.28,0.0398,0.0846,0.0322,0.0524,0.571,0.821,0.285,0.619), method = "BH")
  # 0.4130000 0.4187273 0.1393000 0.1393000 0.1692000 0.4130000 0.1393000 0.1692000 0.1393000 0.1467200 0.6661667 0.8210000 0.4130000 0.6666154


# Add up all normalized counts of sporulation genes
spore.sum <- spore.df %>%
  group_by(Sample, Season) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance),
            Total = sum(Abundance))

summary(aov(formula = Total ~ Season, data=spore.sum))
  # p-value = 0.104
```


### COG Category - Create DESeq object
```{r}
# https://www.bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html
# https://compbiocore.github.io/deseq-workshop-1/assets/deseq_workshop_1.html
# https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html

### Convert phyloseq object to deseq2 object
cog.cat.dds <- phyloseq_to_deseq2(cog.cat.phy, ~Season)
  # Design variable must be unordered otherwise you get an error
cog.cat.dds$Season <- factor(cog.cat.dds$Season, levels=c("Summer", "Winter", "Spring"))

# DESeq DataStructure for analyses
cog.cat.dds <- DESeq(cog.cat.dds, fitType = 'local')

# Hellinger-transformed data for visualizations
cog.cat.hell <- hellinger(t(assay(cog.cat.dds)))
```

### COG Category - Clustering
```{r}
cog.cat.dist <- dist(cog.cat.hell, method = "euclidean")
cog.cat.dist.matrix <- as.matrix(cog.cat.dist)
rownames(cog.cat.dist.matrix) <- meta$Season
colnames(cog.cat.dist.matrix) <- meta$Season


# Dendrogram
cog.cat.hclust <- hclust(cog.cat.dist, method = "average")
cog.cat.den <- as.dendrogram(cog.cat.hclust)
cog.cat.den.data <- dendro_data(cog.cat.den, type = "rectangle")
cog.cat.den.data$labels[,3] <- c("Summer", "Winter", "Winter", "Winter", "Summer", "Spring", "Spring", "Spring", "Summer")
cog.cat.den.data$labels[,3] <- ordered(cog.cat.den.data$labels[,3], levels=c("Summer", "Winter", "Spring"))


#tiff("cog.cat.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(cog.cat.den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = cog.cat.den.data$labels, aes(x, y, label=label, colour=label, fontface = "bold"),
            hjust=0, size=5) +
  ylab("Hellinger Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("darkgoldenrod3", "dodgerblue3", "green4")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()
```


### COG Category - PCoA & PERMANOVA
```{r}
cog.cat.pcoa <- pcoa(cog.cat.dist)
  # Total variation explained = 71.5%
cog.cat.phy.ord <- cog.cat.norm.phy
sample_data(cog.cat.phy.ord)$Season <- ordered(sample_data(cog.cat.phy.ord)$Season, levels = c("Summer", "Winter", "Spring"))

#tiff("cog.cat.pcoa.tiff", width=7, height=5, units="in", res=300)
plot_ordination(physeq = cog.cat.phy.ord, ordination = cog.cat.pcoa, axes = c(1,2),
                color = "Season") +
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Hellinger Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))
#dev.off()

### Run PERMANOVA on Hellinger distance
adonis(cog.cat.dist ~ Season, data=meta, permutations = 99999)
  # p-value = 0.1306
beta.tax = betadisper(d=cog.cat.dist, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.27
```

### COG All - DESeq
```{r}
### Convert phyloseq object to deseq2 object
cog.dds <- phyloseq_to_deseq2(cog.phy, ~Season)
cog.dds$Season <- factor(cog.dds$Season, levels = c("Summer", "Winter", "Spring"))

# DESeq DataStructure for analyses
cog.dds <- DESeq(cog.dds)

# Hellinger-transformed data for visualizations
cog.hell <- hellinger(t(assay(cog.dds)))
```

### COG All - Clustering
```{r}
cog.dist <- dist(cog.hell, method = "euclidean")
cog.dist.matrix <- as.matrix(cog.dist)
rownames(cog.dist.matrix) <- meta$Season
colnames(cog.dist.matrix) <- meta$Season


# Dendrogram
cog.hclust <- hclust(cog.dist, method = "average")
cog.den <- as.dendrogram(cog.hclust)
cog.den.data <- dendro_data(cog.den, type = "rectangle")
cog.den.data$labels[,3] <- c("Summer", "Winter", "Winter", "Winter", "Summer", "Spring", "Spring", "Spring", "Summer")
cog.den.data$labels[,3] <- ordered(cog.den.data$labels[,3], levels=c("Summer", "Winter", "Spring"))


#tiff("cog.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(cog.den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = cog.den.data$labels, aes(x, y, label=label, colour=label, fontface = "bold"),
            hjust=0, size=5) +
  ylab("Hellinger Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("darkgoldenrod3", "dodgerblue3", "green4")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()
```


### COG All - PCoA & PERMANOVA
```{r}
cog.pcoa <- pcoa(cog.dist)
  # Total variation explained = 62.4%
cog.phy.ord <- cog.norm.phy
sample_data(cog.phy.ord)$Season <- ordered(sample_data(cog.phy.ord)$Season, levels = c("Summer", "Winter", "Spring"))



tiff("aaas.cog.pcoa.tiff", width=8, height=6, units="in", res=300)
plot_ordination(physeq = cog.phy.ord, ordination = cog.pcoa, axes = c(1,2),
                color = "Season") +
  geom_point(size=10) +
  scale_color_manual(values=c("#00cccc", "#008484", "#004f4f")) +
  ggtitle("COG Profiles") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_blank())
dev.off()




### Run PERMANOVA on Hellinger distance
adonis(cog.dist ~ Season, data=meta, permutations = 99999)
  # p-value = 0.02154
beta.tax = betadisper(d=cog.dist, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.731



### Pairwise PERMANOVA Comparisons
cog.dist.matrix <- as.matrix(cog.dist)
cog.dist.df <- data.frame(cog.dist.matrix)

# Summer vs. Winter
cog.sw.dist.df <- cog.dist.df[,-5]
cog.sw.dist.df <- cog.sw.dist.df[,-7:-8]
cog.sw.dist.df <- cog.sw.dist.df[-5,]
cog.sw.dist.df <- cog.sw.dist.df[-7:-8,]
cog.sw.dist <- as.dist(cog.sw.dist.df)
meta.sw <- meta[-which(meta$Season == "Spring"),]
adonis(cog.sw.dist ~ Season, data=meta.sw, permutations= 99999)
  # p-value = 0.2

# Summer vs. Spring
cog.sp.dist.df <- cog.dist.df[,-3:-4]
cog.sp.dist.df <- cog.sp.dist.df[,-5]
cog.sp.dist.df <- cog.sp.dist.df[-3:-4,]
cog.sp.dist.df <- cog.sp.dist.df[-5,]
cog.sp.dist <- as.dist(cog.sp.dist.df)
meta.sp <- meta[-which(meta$Season == "Winter"),]
adonis(cog.sp.dist ~ Season, data=meta.sp, permutations= 99999)
  # p-value = 0.2

# Spring vs. Winter
cog.wp.dist.df <- cog.dist.df[,-3:-4]
cog.wp.dist.df <- cog.wp.dist.df[,-5]
cog.wp.dist.df <- cog.wp.dist.df[-3:-4,]
cog.wp.dist.df <- cog.wp.dist.df[-5,]
cog.wp.dist <- as.dist(cog.wp.dist.df)
meta.wp <- meta[-which(meta$Season == "Summer"),]
adonis(cog.wp.dist ~ Season, data=meta.wp, permutations= 99999)
  # p-value = 0.2
```

### COG All - DESeq - find overrep genes
```{r}
# Pull out results from pairwise comparison
cog.sw <- results(cog.dds, contrast = c("Season", "Summer", "Winter"))
cog.sw.sig <- cog.sw[which(cog.sw$padj < 0.05),]
cog.sw.sig[which(cog.sw.sig$log2FoldChange > 0),]
  # Enriched in Summer compared to Winter (positive log2FoldChange)
    # COG2207, COG3345, COG3507, COG3693, COG3866, COG3940
cog.sw.sig[which(cog.sw.sig$log2FoldChange < 0),]
  # Enriched in Winter compared to Summer (negative log2FoldChange)
    # COG3246


cog.sp <- results(cog.dds, contrast = c("Season", "Summer", "Spring"))
cog.sp.sig <- cog.sp[which(cog.sp$padj < 0.05),]
  # Enriched in Summer compared to Spring (positive log2FoldChange)
    # COG0243, COG0437, COG0457, COG1240, COG1629, COG2825, COG2885


cog.wp <- results(cog.dds, contrast = c("Season", "Winter", "Spring"))
cog.wp.sig <- cog.wp[which(cog.wp$padj < 0.05),]
cog.wp.sig[which(cog.wp.sig$log2FoldChange > 0),]
  # Enriched in Winter compared to Spring (positive log2FoldChange)
    # COG0457, COG0760, COG0774, COG1452, COG1463, COG1629, COG2825, COG2885, COG3637, COG4775
cog.wp.sig[which(cog.wp.sig$log2FoldChange < 0),]
  # Enriched in Spring compared to Winter (negative log2FoldChange)
    # COG0004, COG0246, COG0395, COG0561, COG1026, COG1061, COG1070, COG1105, COG1131, COG1132, COG1136, COG1175, COG1472, COG1511, COG1609, COG1653, COG1874, COG1925, COG2182, COG2190, COG2207, COG2730, COG2972, COG3044, COG3345, COG3664, COG3693, COG3757, COG3866, COG3940, COG3973, COG4284, COG4485, COG4709, COG4753, COG5578

```



### COG All - DESeq heatmap of normalized + transformed counts
```{r}
# Prepare data
cog.hell.otu <- otu_table(t(cog.hell), taxa_are_rows = T)
colnames(cog.hell.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744",
                              "3772", "3773" , "3775")
cog.sig <- merge_phyloseq(cog.hell.otu, tax_table(cog.phy),
                            sample_data(cog.phy))
cog.sum.sig <- subset_taxa(cog.sig, COG == "COG3866" | COG == "COG3693" | COG == "COG3345" |
                           COG == "COG3940" | COG == "COG2207" | COG == "COG3507" |
                           COG == "COG1629" | COG == "COG0457" | COG == "COG2885" |
                           COG == "COG2825" | COG == "COG1240" | COG == "COG0437" |
                           COG == "COG0243")
cog.win.sig <- subset_taxa(cog.sig, COG == "COG0457" | COG == "COG1463" | COG == "COG1629" | 
                             COG == "COG0760" | COG == "COG4775" | COG == "COG3637" |
                             COG == "COG2885" | COG == "COG2825" | COG == "COG1452" |
                             COG == "COG0774" | COG == "COG3246")
cog.spr.sig <- subset_taxa(cog.sig, COG == "COG1136" | COG == "COG1132" | COG == "COG1131" |
                             COG == "COG4753" | COG == "COG2972" | COG == "COG5578" | 
                             COG == "COG4709"| COG == "COG4485" | COG == "COG1511" | 
                             COG == "COG3940"| COG == "COG1026" | COG == "COG0561" |
                             COG == "COG3973"| COG == "COG3044" | COG == "COG0004" |
                             COG == "COG3757" | COG == "COG1061" | COG == "COG2207" |
                             COG == "COG1609" | COG == "COG3866" | COG == "COG3693" |
                             COG == "COG3345" | COG == "COG3507" | COG == "COG4284" |
                             COG == "COG3664" | COG == "COG2730" | COG == "COG2190" |
                             COG == "COG2182" | COG == "COG1925" | COG == "COG1874" |
                             COG == "COG1653" | COG == "COG1472" | COG == "COG1175" |
                             COG == "COG1105" | COG == "COG1070" | COG == "COG0395" |
                             COG == "COG0246")


cog.act.sig <- subset_taxa(cog.sig, COG == "COG3940" | COG == "COG3866" | 
                             COG == "COG3693" | COG == "COG3345" | COG == "COG2207")
cog.win5.sig <- subset_taxa(cog.sig, COG == "COG0774" | COG == "COG1452" | 
                              COG == "COG2825" | COG == "COG2885" | COG == "COG3637")
                            



##### PLOT #####

## Summer ##
#tiff("cog.heatmap.sum.tiff", width=8.4, height=10, units="in", res=300)
plot_heatmap(cog.sum.sig, sample.label = "Season", sample.order = c("3715", "3717", "3744", "3723", "3733", "3772", "3734", "3773", "3775"), 
             taxa.order = c("COG3866", "COG3693", "COG3345", "COG3940", "COG2207", "COG3507",
                            "COG1629", "COG0457", "COG2885", "COG2825", "COG1240", "COG0437",
                            "COG0243")) +
  geom_tile(colour="gray40") +
  scale_x_discrete(position = "top", labels=c("Summer", "Summer", "Summer", "Winter", "Winter", "Winter", "Spring", "Spring", "Spring")) +
  xlab("Season\n\n") +
  ylab("COGs\n\n") +
  scale_fill_gradientn(name=expression("Hellinger-\nTransformed\nNormalized\nCounts\n"),
                       limits = c(0.00,0.091),
                       breaks = c(0.000, 0.015, 0.030, 0.045, 0.060, 0.075, 0.090),
                       labels = c("0.000", "0.015", "0.030", "0.045", "0.060", "0.075", "0.090"),
                       colours = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976",
                                   "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c",
                                   "#bd0026", "#800026", "#33000f")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=20),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=20, face="bold"),
        axis.title.y = element_text(size=20, face="bold"),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20)) +
  guides(fill = guide_colorbar(barheight = unit(7,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()


## Winter ##
#tiff("cog.heatmap.win.tiff", width=8.4, height=10, units="in", res=300)
plot_heatmap(cog.win.sig, sample.label = "Season", sample.order = c("3715", "3717", "3744", "3723", "3733", "3772", "3734", "3773", "3775"), 
             taxa.order = c("COG0457", "COG1463","COG1629", "COG0760", "COG4775", "COG3637",
                            "COG2885" , "COG2825" , "COG1452", "COG0774", "COG3246")) +
  geom_tile(colour="gray40") +
  scale_x_discrete(position = "top", labels=c("Summer", "Summer", "Summer", "Winter", "Winter", "Winter", "Spring", "Spring", "Spring")) +
  xlab("Season\n\n") +
  ylab("COGs\n\n") +
  scale_fill_gradientn(name=expression("Hellinger-\nTransformed\nNormalized\nCounts\n"),
                       limits = c(0.00,0.091),
                       breaks = c(0.000, 0.015, 0.030, 0.045, 0.060, 0.075, 0.090),
                       labels = c("0.000", "0.015", "0.030", "0.045", "0.060", "0.075", "0.090"),
                       colours = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976",
                                   "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c",
                                   "#bd0026", "#800026", "#33000f")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=20),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=20, face="bold"),
        axis.title.y = element_text(size=20, face="bold"),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20)) +
  guides(fill = guide_colorbar(barheight = unit(7,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()




## Spring ##
#tiff("cog.heatmap.spr.tiff", width=8, height=10, units="in", res=300)
plot_heatmap(cog.spr.sig, sample.label = "Season", sample.order = c("3715", "3717", "3744", "3723", "3733", "3772", "3734", "3773", "3775"), 
             taxa.order = c("COG1136", "COG1132", "COG1131", "COG4753", "COG2972", "COG5578",
                            "COG4709", "COG4485", "COG1511", "COG3940", "COG1026", "COG0561",
                            "COG3973", "COG3044", "COG0004", "COG3757", "COG1061", "COG2207",
                            "COG1609", "COG3866", "COG3693", "COG3345", "COG3507", "COG4284",
                            "COG3664", "COG2730", "COG2190", "COG2182", "COG1925", "COG1874",
                            "COG1653", "COG1472", "COG1175", "COG1105", "COG1070", "COG0395",
                            "COG0246")) +
  geom_tile(colour="gray40") +
  scale_x_discrete(position = "top", labels=c("Summer", "Summer", "Summer", "Winter", "Winter", "Winter", "Spring", "Spring", "Spring")) +
  xlab("Season\n\n") +
  ylab("COGs") +
  scale_fill_gradientn(name=expression("Hellinger-\nTransformed\nNormalized\nCounts\n"),
                       limits = c(0.00,0.085),
                       breaks = c(0.000, 0.017, 0.034, 0.051, 0.068, 0.085),
                       labels = c("0.000", "0.017", "0.034", "0.051", "0.068", "0.085"),
                       colours = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976",
                                   "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c",
                                   "#bd0026", "#800026", "#33000f")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=20),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=20, face="bold"),
        axis.title.y = element_text(size=20, face="bold"),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20)) +
  guides(fill = guide_colorbar(barheight = unit(7,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()









#tiff("aaas.cog.active.heatmap.tiff", width=7, height=3, units="in", res=300)
plot_heatmap(cog.act.sig, sample.label = "Season", sample.order = c("3715", "3717", "3744", "3723", "3733", "3772", "3734", "3773", "3775"), 
             taxa.order = c("COG3940", "COG3866", "COG3693", "COG3345", "COG2207")) +
  geom_tile(colour="gray40") +
  scale_x_discrete(position = "top", labels=c("Summer", "Summer", "Summer", "Winter", "Winter", "Winter", "Spring", "Spring", "Spring")) +
  xlab("Season\n\n") +
  ylab("COGs\n\n") +
  scale_fill_gradientn(name=expression("Hellinger-\nTransformed\nNormalized\nCounts\n"),
                       limits = c(0.004, 0.077),
                       #breaks = c(0.000, 0.015, 0.030, 0.045, 0.060, 0.075, 0.090),
                       #labels = c("0.000", "0.015", "0.030", "0.045", "0.060", "0.075", "0.090"),
                       colours = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976",
                                   "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c",
                                   "#bd0026", "#800026", "#33000f")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=20),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=20, face="bold"),
        axis.title.y = element_text(size=20, face="bold"),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20)) +
  guides(fill = guide_colorbar(barheight = unit(1,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()



#tiff("aaas.cog.winter.heatmap.tiff", width=7, height=3, units="in", res=300)
plot_heatmap(cog.win5.sig, sample.label = "Season", sample.order = c("3715", "3717", "3744", "3723", "3733", "3772", "3734", "3773", "3775"), 
             taxa.order = c("COG3637", "COG2885", "COG2825", "COG1452", "COG0774")) +
  geom_tile(colour="gray40") +
  scale_x_discrete(position = "top", labels=c("Summer", "Summer", "Summer", "Winter", "Winter", "Winter", "Spring", "Spring", "Spring")) +
  xlab("Season\n\n") +
  ylab("COGs\n\n") +
  scale_fill_gradientn(name=expression("Hellinger-\nTransformed\nNormalized\nCounts\n"),
                       limits = c(0.005, 0.040),
                       #breaks = c(0.000, 0.015, 0.030, 0.045, 0.060, 0.075, 0.090),
                       #labels = c("0.000", "0.015", "0.030", "0.045", "0.060", "0.075", "0.090"),
                       colours = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976",
                                   "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c",
                                   "#bd0026", "#800026", "#33000f")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=20),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=20, face="bold"),
        axis.title.y = element_text(size=20, face="bold"),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20)) +
  guides(fill = guide_colorbar(barheight = unit(1,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()
```
