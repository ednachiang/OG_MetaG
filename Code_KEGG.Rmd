---
title: "KEGG Code"
author: "Edna Chiang"
date: "2/9/2021"
output: html_document
---

### Load Libraries
```{r}
library('readr')
library('pgirmess')
library('ggplot2')
library('grid')
library('phyloseq')
library('DESeq2')
library('phangorn')
library('vegan')
library('pheatmap')
library('RColorBrewer')
library('gplots')
library('tidyr')
library('dplyr')
library('stringr')
library('lme4')
library('picante')
library('ggdendro')
library('fitdistrplus')
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/misc.R')
source('scripts/simper.R')
source('scripts/pairwise.adonis.R')
```


### KEGG - Create phyloseq object
```{r}
# Load "otu" data
kegg1 <- read.csv('KEGG/musicc_outputs/test1/cat1.csv', header=T, row.names=1)
colnames(kegg1) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg2 <- read.csv('KEGG/musicc_outputs/test1/cat2.csv', header=T, row.names=1)
colnames(kegg2) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg2 <- kegg2[,-ncol(kegg2)]
kegg3 <- read.csv('KEGG/musicc_outputs/test1/path.csv', header=T, row.names=1)
colnames(kegg3) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg3 <- kegg3[,-ncol(kegg3)]
kegg3 <- kegg3[,-ncol(kegg3)]
#kegg4 <- read.csv('KEGG/musicc_outputs/test4/cat1.csv', header=T, row.names=1)
#colnames(kegg4) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")

# Load "tax" table
kegg.class <- read.csv('KEGG/KOID_Pathway_Classifications.csv', header = T)
unique.cat1 <- unique(kegg.class$Category1)
unique.cat1 <- data.frame(unique.cat1)
rownames(unique.cat1) <- unique.cat1[,1]
colnames(unique.cat1) <- "Category1"

cat2.merged <- paste(kegg.class$Category1, ":", kegg.class$Category2)
unique.cat2 <- unique(cat2.merged)
unique.cat2 <- data.frame(unique.cat2)
cat2.split <- strsplit(unique.cat2[,1], split = " : ")
cat2.df <- data.frame(matrix(nrow = length(cat2.split), ncol = 2))
for(i in 1:length(cat2.split)){
  cat2.df[i,] <- t(unlist(cat2.split[i]))
}
rownames(cat2.df) <- cat2.df[,2]
colnames(cat2.df) <- c("Category1", "Category2")

cat3.merged <- paste(kegg.class$Category1, ":", kegg.class$Category2, ":", kegg.class$Pathway)
unique.cat3 <- unique(cat3.merged)
unique.cat3 <- data.frame(unique.cat3)
cat3.split <- strsplit(unique.cat3[,1], split = " : ")
cat3.df <- data.frame(matrix(nrow = length(cat3.split), ncol = 3))
for(i in 1:length(cat3.split)){
  cat3.df[i,] <- t(unlist(cat3.split[i]))
}
rownames(cat3.df) <- cat3.df[,3]
colnames(cat3.df) <- c("Category1", "Category2", "Pathway")

# Prepare phyloseq object inputs
kegg1.otu <- otu_table(kegg1, taxa_are_rows = T)
cat1.tax <- tax_table(unique.cat1)
taxa_names(cat1.tax) <- unique.cat1[,1]
meta <- read.csv('metadata.csv', row.names=1)

kegg2.otu <- otu_table(kegg2, taxa_are_rows = T)
cat2.tax <- tax_table(cat2.df)
taxa_names(cat2.tax) <- cat2.df[,2]

kegg3.otu <- otu_table(kegg3, taxa_are_rows = T)
cat3.tax <- tax_table(cat3.df)
taxa_names(cat3.tax) <- cat3.df[,3]

# Create phyloseq object
kegg1.phy <- merge_phyloseq(kegg1.otu, cat1.tax, sample_data(meta))
kegg2.phy <- merge_phyloseq(kegg2.otu, cat2.tax, sample_data(meta))
kegg3.phy <- merge_phyloseq(kegg3.otu, cat3.tax, sample_data(meta))
```
### KEGG - Cat1 Kruskal-Wallis
```{r}
# Load data
kegg1 <- read.csv('KEGG/musicc_outputs/test1/cat1.csv', header=T, row.names=1)
kegg2 <- read.csv('KEGG/musicc_outputs/test2/cat1.csv', header=T, row.names=1)
kegg3 <- read.csv('KEGG/musicc_outputs/test3/cat1.csv', header=T, row.names=1)
kegg4 <- read.csv('KEGG/musicc_outputs/test4/cat1.csv', header=T, row.names=1)



# Format data
kegg1.df <- data.frame(t(kegg1))
rownames(kegg1.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg1.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg1.df$Season <- ordered(kegg1.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg2.df <- data.frame(t(kegg2))
rownames(kegg2.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg2.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg2.df$Season <- ordered(kegg2.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg3.df <- data.frame(t(kegg3))
rownames(kegg3.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg3.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg3.df$Season <- ordered(kegg3.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg4.df <- data.frame(t(kegg4))
rownames(kegg4.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg4.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg4.df$Season <- ordered(kegg4.df$Season, levels=c("Summer", "Winter", "Spring"))


# Run Kruskal-Wallis on normalized KEGG counts
kegg1.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg1)))
colnames(kegg1.kw) <- rownames(kegg1)
for(i in 1:nrow(kegg1)){
  koid <- colnames(kegg1.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg1.df)
  kegg1.kw[,i] <- kw$p.value
}
kegg1.kw[2,] <- p.adjust(kegg1.kw[1,], method = "fdr")
which(kegg1.kw[2,] < 0.05)

kegg2.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg2)))
colnames(kegg2.kw) <- rownames(kegg2)
for(i in 1:nrow(kegg2)){
  koid <- colnames(kegg2.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg2.df)
  kegg2.kw[,i] <- kw$p.value
}
kegg2.kw[2,] <- p.adjust(kegg2.kw[1,], method = "fdr")
which(kegg2.kw[2,] < 0.05)

kegg3.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg3)))
colnames(kegg3.kw) <- rownames(kegg3)
for(i in 1:nrow(kegg3)){
  koid <- colnames(kegg3.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg3.df)
  kegg3.kw[,i] <- kw$p.value
}
kegg3.kw[2,] <- p.adjust(kegg3.kw[1,], method = "fdr")
which(kegg3.kw[2,] < 0.05)

kegg4.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg4)))
colnames(kegg4.kw) <- rownames(kegg4)
for(i in 1:nrow(kegg4)){
  koid <- colnames(kegg4.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg4.df)
  kegg4.kw[,i] <- kw$p.value
}
kegg4.kw[2,] <- p.adjust(kegg4.kw[1,], method = "fdr")
which(kegg4.kw[2,] < 0.05)
```


### KEGG - Cat2 Kruskal-Wallis
```{r}
# Load data
kegg1 <- read.csv('KEGG/musicc_outputs/test1/Cat2.csv', header=T, row.names=1)
kegg1 <- kegg1[,-ncol(kegg1)]
kegg2 <- read.csv('KEGG/musicc_outputs/test2/Cat2.csv', header=T, row.names=1)
kegg2 <- kegg2[,-ncol(kegg2)]
kegg3 <- read.csv('KEGG/musicc_outputs/test3/Cat2.csv', header=T, row.names=1)
kegg3 <- kegg3[,-ncol(kegg3)]
kegg4 <- read.csv('KEGG/musicc_outputs/test4/Cat2.csv', header=T, row.names=1)
kegg4 <- kegg4[,-ncol(kegg4)]


# Format data
kegg1.df <- data.frame(t(kegg1))
rownames(kegg1.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg1.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg1.df$Season <- ordered(kegg1.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg2.df <- data.frame(t(kegg2))
rownames(kegg2.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg2.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg2.df$Season <- ordered(kegg2.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg3.df <- data.frame(t(kegg3))
rownames(kegg3.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg3.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg3.df$Season <- ordered(kegg3.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg4.df <- data.frame(t(kegg4))
rownames(kegg4.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg4.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg4.df$Season <- ordered(kegg4.df$Season, levels=c("Summer", "Winter", "Spring"))


# Run Kruskal-Wallis on normalized KEGG counts
kegg1.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg1)))
colnames(kegg1.kw) <- rownames(kegg1)
for(i in 1:nrow(kegg1)){
  koid <- colnames(kegg1.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg1.df)
  kegg1.kw[,i] <- kw$p.value
}
kegg1.kw[2,] <- p.adjust(kegg1.kw[1,], method = "fdr")
which(kegg1.kw[2,] < 0.05)

kegg2.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg2)))
colnames(kegg2.kw) <- rownames(kegg2)
for(i in 1:nrow(kegg2)){
  koid <- colnames(kegg2.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg2.df)
  kegg2.kw[,i] <- kw$p.value
}
kegg2.kw[2,] <- p.adjust(kegg2.kw[1,], method = "fdr")
which(kegg2.kw[2,] < 0.05)

kegg3.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg3)))
colnames(kegg3.kw) <- rownames(kegg3)
for(i in 1:nrow(kegg3)){
  koid <- colnames(kegg3.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg3.df)
  kegg3.kw[,i] <- kw$p.value
}
kegg3.kw[2,] <- p.adjust(kegg3.kw[1,], method = "fdr")
which(kegg3.kw[2,] < 0.05)

kegg4.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg4)))
colnames(kegg4.kw) <- rownames(kegg4)
for(i in 1:nrow(kegg4)){
  koid <- colnames(kegg4.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg4.df)
  kegg4.kw[,i] <- kw$p.value
}
kegg4.kw[2,] <- p.adjust(kegg4.kw[1,], method = "fdr")
which(kegg4.kw[2,] < 0.05)
```


### KEGG - Path Kruskal-Wallis
```{r}
# Load data
kegg1 <- read.csv('KEGG/musicc_outputs/test1/path.csv', header=T, row.names=1)
kegg1 <- kegg1[,-ncol(kegg1)]
kegg1 <- kegg1[,-ncol(kegg1)]
kegg2 <- read.csv('KEGG/musicc_outputs/test2/path.csv', header=T, row.names=1)
kegg2 <- kegg2[,-ncol(kegg2)]
kegg2 <- kegg2[,-ncol(kegg2)]
kegg3 <- read.csv('KEGG/musicc_outputs/test3/path.csv', header=T, row.names=1)
kegg3 <- kegg3[,-ncol(kegg3)]
kegg3 <- kegg3[,-ncol(kegg3)]
kegg4 <- read.csv('KEGG/musicc_outputs/test4/path.csv', header=T, row.names=1)
kegg4 <- kegg4[,-ncol(kegg4)]
kegg4 <- kegg4[,-ncol(kegg4)]


# Format data
kegg1.df <- data.frame(t(kegg1))
rownames(kegg1.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg1.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg1.df$Season <- ordered(kegg1.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg2.df <- data.frame(t(kegg2))
rownames(kegg2.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg2.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg2.df$Season <- ordered(kegg2.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg3.df <- data.frame(t(kegg3))
rownames(kegg3.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg3.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg3.df$Season <- ordered(kegg3.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg4.df <- data.frame(t(kegg4))
rownames(kegg4.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg4.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg4.df$Season <- ordered(kegg4.df$Season, levels=c("Summer", "Winter", "Spring"))


# Run Kruskal-Wallis on normalized KEGG counts
kegg1.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg1)))
colnames(kegg1.kw) <- rownames(kegg1)
for(i in 1:nrow(kegg1)){
  koid <- colnames(kegg1.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg1.df)
  kegg1.kw[,i] <- kw$p.value
}
kegg1.kw[2,] <- p.adjust(kegg1.kw[1,], method = "fdr")
which(kegg1.kw[2,] < 0.05)

kegg2.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg2)))
colnames(kegg2.kw) <- rownames(kegg2)
for(i in 1:nrow(kegg2)){
  koid <- colnames(kegg2.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg2.df)
  kegg2.kw[,i] <- kw$p.value
}
kegg2.kw[2,] <- p.adjust(kegg2.kw[1,], method = "fdr")
which(kegg2.kw[2,] < 0.05)

kegg3.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg3)))
colnames(kegg3.kw) <- rownames(kegg3)
for(i in 1:nrow(kegg3)){
  koid <- colnames(kegg3.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg3.df)
  kegg3.kw[,i] <- kw$p.value
}
kegg3.kw[2,] <- p.adjust(kegg3.kw[1,], method = "fdr")
which(kegg3.kw[2,] < 0.05)

kegg4.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg4)))
colnames(kegg4.kw) <- rownames(kegg4)
for(i in 1:nrow(kegg4)){
  koid <- colnames(kegg4.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg4.df)
  kegg4.kw[,i] <- kw$p.value
}
kegg4.kw[2,] <- p.adjust(kegg4.kw[1,], method = "fdr")
which(kegg4.kw[2,] < 0.05)
```



### KEGG - KOID Kruskal-Wallis
```{r}
# Load data
kegg1 <- read.csv('KEGG/musicc_outputs/KEGG_MUSiCC_all1.tab', header=T, sep = "\t")
kegg2 <- read.csv('KEGG/musicc_outputs/KEGG_MUSiCC_all2.tab', header=T, sep = "\t")
kegg3 <- read.csv('KEGG/musicc_outputs/KEGG_MUSiCC_all3.tab', header=T, sep = "\t")
kegg4 <- read.csv('KEGG/musicc_outputs/KEGG_MUSiCC_all4.tab', header=T, sep = "\t")

# Format data
kegg1.df <- data.frame(t(kegg1))
colnames(kegg1.df) <- kegg1.df[1,]
kegg1.df <- kegg1.df[-1,]
rownames(kegg1.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg1.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg1.df$Season <- ordered(kegg1.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg2.df <- data.frame(t(kegg2))
colnames(kegg2.df) <- kegg2.df[1,]
kegg2.df <- kegg2.df[-1,]
rownames(kegg2.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg2.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg2.df$Season <- ordered(kegg2.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg3.df <- data.frame(t(kegg3))
colnames(kegg3.df) <- kegg3.df[1,]
kegg3.df <- kegg3.df[-1,]
rownames(kegg3.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg3.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg3.df$Season <- ordered(kegg3.df$Season, levels=c("Summer", "Winter", "Spring"))

kegg4.df <- data.frame(t(kegg4))
colnames(kegg4.df) <- kegg4.df[1,]
kegg4.df <- kegg4.df[-1,]
rownames(kegg4.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
kegg4.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
kegg4.df$Season <- ordered(kegg4.df$Season, levels=c("Summer", "Winter", "Spring"))


# Run Kruskal-Wallis on normalized KEGG counts
kegg1.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg1)))
colnames(kegg1.kw) <- kegg1[,1]
for(i in 1:nrow(kegg1)){
  koid <- colnames(kegg1.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg1.df)
  kegg1.kw[,i] <- kw$p.value
}
kegg1.kw[2,] <- p.adjust(kegg1.kw[1,], method = "fdr")
which(kegg1.kw[2,] < 0.05)

kegg2.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg2)))
colnames(kegg2.kw) <- kegg2[,1]
for(i in 1:nrow(kegg2)){
  koid <- colnames(kegg2.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg2.df)
  kegg2.kw[,i] <- kw$p.value
}
kegg2.kw[2,] <- p.adjust(kegg2.kw[1,], method = "fdr")
which(kegg2.kw[2,] < 0.05)

kegg3.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg3)))
colnames(kegg3.kw) <- kegg3[,1]
for(i in 1:nrow(kegg3)){
  koid <- colnames(kegg3.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg3.df)
  kegg3.kw[,i] <- kw$p.value
}
kegg3.kw[2,] <- p.adjust(kegg3.kw[1,], method = "fdr")
which(kegg3.kw[2,] < 0.05)

kegg4.kw <- data.frame(matrix(nrow = 1, ncol = nrow(kegg4)))
colnames(kegg4.kw) <- kegg4[,1]
for(i in 1:nrow(kegg4)){
  koid <- colnames(kegg4.df)[i]
  kw <- kruskal.test(formula = reformulate("Season", koid), data = kegg4.df)
  kegg4.kw[,i] <- kw$p.value
}
kegg4.kw[2,] <- p.adjust(kegg4.kw[1,], method = "fdr")
which(kegg4.kw[2,] < 0.05)
```


### KEGG - Cat1 Cluster Analysis
```{r}
kegg1 <- read.csv('KEGG/musicc_outputs/test1/cat1.csv', header=T, row.names=1)


kegg1.cat1.dist <- dist(t(kegg1))
kegg1.cat1.dist.matrix <- as.matrix(kegg1.cat1.dist)
rownames(kegg1.cat1.dist.matrix) <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
colnames(kegg1.cat1.dist.matrix) <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")

# Heatmap
pheatmap(kegg1.cat1.dist.matrix, clustering_distance_rows = kegg1.cat1.dist, 
         clustering_distance_cols = kegg1.cat1.dist, col = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026"))


# Dendrogram
kegg1.cat1.hclust <- hclust(kegg1.cat1.dist)
kegg1.cat1.den <- as.dendrogram(kegg1.cat1.hclust)
kegg1.cat1.den.data <- dendro_data(kegg1.cat1.den, type = "rectangle")
kegg1.cat1.den.data$labels[,3] <- c("Summer", "Winter", "Winter", "Winter", "Summer", "Spring", "Spring", "Spring", "Summer")
kegg1.cat1.den.data$labels[,3] <- ordered(kegg1.cat1.den.data$labels[,3], levels=c("Summer", "Winter", "Spring"))


#tiff("dbcan.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(kegg1.cat1.den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = kegg1.cat1.den.data$labels, 
            aes(x, y, label=label, colour=label, fontface = "bold"),
            hjust=0, size=5) +
  ylab("Euclidean Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("darkgoldenrod3", "dodgerblue3", "green4")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()





### PCA - Euclidean
cat1.pca <- ordinate(physeq = kegg1.phy, method = "PCoA", distance = "euclidean")

plot_ordination(physeq = kegg1.phy, ordination = cat1.pca, axes = c(1, 2),
                color="Season") + 
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Euclidean Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))
  
 


### Test normality
hist(kegg1.cat1.dist)
qqnorm(kegg1.cat1.dist)
qqline(kegg1.cat1.dist)
shapiro.test(kegg1.cat1.dist)
  # p-value = 0.03504
  # Not Normal

### Run PERMANOVA on Euclidean distance
adonis(kegg1.cat1.dist ~ Season, data=meta, permutations = 99999)
  # p-value = 0.287
beta.tax = betadisper(d=kegg1.cat1.dist, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.764




### PCA - Bray-Curtis
cat1.pca.bc <- ordinate(physeq = kegg1.phy, method = "PCoA", distance = "bray")

plot_ordination(physeq = kegg1.phy, ordination = cat1.pca.bc, axes = c(1, 2),
                color="Season") + 
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Euclidean Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))

### Run PERMANOVA on Bray-Curtis
cat1.bray <- phyloseq::distance(physeq=kegg1.phy, method="bray")
adonis(cat1.bray ~ Season, data=meta, permutations = 99999)
  # p-value = 0.2069
beta.tax = betadisper(d=cat1.bray, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.736
```

### KEGG - Cat2 Cluster Analysis
```{r}
kegg1 <- read.csv('KEGG/musicc_outputs/test1/cat2.csv', header=T, row.names=1)
kegg1 <- kegg1[,-ncol(kegg1)]

kegg1.cat2.dist <- dist(t(kegg1))
kegg1.cat2.dist.matrix <- as.matrix(kegg1.cat2.dist)
rownames(kegg1.cat2.dist.matrix) <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
colnames(kegg1.cat2.dist.matrix) <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")

# Heatmap
pheatmap(kegg1.cat2.dist.matrix, clustering_distance_rows = kegg1.cat2.dist, 
         clustering_distance_cols = kegg1.cat2.dist, col = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026"))


# Dendrogram
kegg1.cat2.hclust <- hclust(kegg1.cat2.dist)
kegg1.cat2.den <- as.dendrogram(kegg1.cat2.hclust)
kegg1.cat2.den.data <- dendro_data(kegg1.cat2.den, type = "rectangle")
kegg1.cat2.den.data$labels[,3] <- c("Summer", "Winter", "Winter", "Winter", "Summer", "Spring", "Spring", "Spring", "Summer")
kegg1.cat2.den.data$labels[,3] <- ordered(kegg1.cat2.den.data$labels[,3], levels=c("Summer", "Winter", "Spring"))


#tiff("dbcan.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(kegg1.cat2.den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = kegg1.cat2.den.data$labels, 
            aes(x, y, label=label, colour=label, fontface = "bold"),
            hjust=0, size=5) +
  ylab("Euclidean Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("darkgoldenrod3", "dodgerblue3", "green4")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()





### PCA - Euclidean
cat2.pca <- ordinate(physeq = kegg2.phy, method = "PCoA", distance = "euclidean")

plot_ordination(physeq = kegg2.phy, ordination = cat2.pca, axes = c(1, 2),
                color="Season") + 
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Euclidean Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))
  
 


### Test normality
hist(kegg1.cat2.dist)
qqnorm(kegg1.cat2.dist)
qqline(kegg1.cat2.dist)
shapiro.test(kegg1.cat2.dist)
  # p-value = 0.01897
  # Not Normal

### Run PERMANOVA on Euclidean distance
adonis(kegg1.cat2.dist ~ Season, data=meta, permutations = 99999)
  # p-value = 0.1712
beta.tax = betadisper(d=kegg1.cat2.dist, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.566




### PCA - Bray-Curtis
cat2.pca.bc <- ordinate(physeq = kegg2.phy, method = "PCoA", distance = "bray")

plot_ordination(physeq = kegg2.phy, ordination = cat2.pca.bc, axes = c(1, 2),
                color="Season") + 
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Euclidean Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))

### Run PERMANOVA on Bray-Curtis
cat2.bray <- phyloseq::distance(physeq=kegg2.phy, method="bray")
adonis(cat2.bray ~ Season, data=meta, permutations = 99999)
  # p-value = 0.253
beta.tax = betadisper(d=cat2.bray, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.673
```


### KEGG - Pathway Cluster Analysis
```{r}
kegg1 <- read.csv('KEGG/musicc_outputs/test1/path.csv', header=T, row.names=1)
kegg1 <- kegg1[,-ncol(kegg1)]
kegg1 <- kegg1[,-ncol(kegg1)]

kegg1.path.dist <- dist(t(kegg1))
kegg1.path.dist.matrix <- as.matrix(kegg1.path.dist)
rownames(kegg1.path.dist.matrix) <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
colnames(kegg1.path.dist.matrix) <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")

# Heatmap
pheatmap(kegg1.path.dist.matrix, clustering_distance_rows = kegg1.path.dist, 
         clustering_distance_cols = kegg1.path.dist, col = c("#FFFFFF", "#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026"))


# Dendrogram
kegg1.path.hclust <- hclust(kegg1.path.dist)
kegg1.path.den <- as.dendrogram(kegg1.path.hclust)
kegg1.path.den.data <- dendro_data(kegg1.path.den, type = "rectangle")
kegg1.path.den.data$labels[,3] <- c("Summer", "Winter", "Winter", "Winter", "Summer", "Spring", "Spring", "Spring", "Summer")
kegg1.path.den.data$labels[,3] <- ordered(kegg1.path.den.data$labels[,3], levels=c("Summer", "Winter", "Spring"))


#tiff("dbcan.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(kegg1.path.den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = kegg1.path.den.data$labels, 
            aes(x, y, label=label, colour=label, fontface = "bold"),
            hjust=0, size=5) +
  ylab("Euclidean Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("darkgoldenrod3", "dodgerblue3", "green4")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()





### PCA - Euclidean
path.pca <- ordinate(physeq = kegg3.phy, method = "PCoA", distance = "euclidean")

plot_ordination(physeq = kegg3.phy, ordination = path.pca, axes = c(1, 2),
                color="Season") + 
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Euclidean Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))
  
 


### Test normality
hist(kegg1.path.dist)
qqnorm(kegg1.path.dist)
qqline(kegg1.path.dist)
shapiro.test(kegg1.path.dist)
  # p-value = 0.02788
  # Not Normal

### Run PERMANOVA on Euclidean distance
adonis(kegg1.path.dist ~ Season, data=meta, permutations = 99999)
  # p-value = 0.01144
beta.tax = betadisper(d=kegg1.path.dist, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.493




### PCA - Bray-Curtis
path.pca.bc <- ordinate(physeq = kegg3.phy, method = "PCoA", distance = "bray")

plot_ordination(physeq = kegg3.phy, ordination = path.pca.bc, axes = c(1, 2),
                color="Season") + 
  geom_point(size=5) +
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Euclidean Distance") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_text(hjust=0.5, size=20))

### Run PERMANOVA on Bray-Curtis
path.bray <- phyloseq::distance(physeq=kegg3.phy, method="bray")
adonis(path.bray ~ Season, data=meta, permutations = 99999)
  # p-value = 0.1573
beta.tax = betadisper(d=path.bray, group=meta$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.537
```