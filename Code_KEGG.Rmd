---
title: "KEGG Code"
author: "Edna Chiang"
date: "2/9/2021"
output: html_document
---

### Load Libraries
```{r}
library('readr')
library('pgirmess')
library('ggplot2')
library('grid')
library('phyloseq')
library('DESeq2')
library('phangorn')
library('vegan')
library('pheatmap')
library('RColorBrewer')
library('gplots')
library('tidyr')
library('dplyr')
library('stringr')
library('lme4')
library('picante')
library('ggdendro')
library('fitdistrplus')
library('amap')
library('labdsv')
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/misc.R')
source('scripts/simper.R')
source('scripts/pairwise.adonis.R')
```

### COG - Create phyloseq objects (DON'T RUN!)
```{r}
### Count-level ###

# Load data
kegg.counts <- read.csv('KEGG/KEGG.table.tab', header = T, sep = "\t", row.names = 1)


# Identify KOIDs that appear in only 1 sample
koid.rem <- list()
for(i in 1:nrow(kegg.counts)){
  empty <- length(which(kegg.counts[i,] == 0))
    # Identifies number of samples without KOID
  if(empty > 7){
    # If KOID appears in only 1 sample
    koid.rem <- append(koid.rem, i)
      # Create list of KOIDs that appear in only 1 sample
  }
}
koid.rem.row <- as.numeric(koid.rem)
  # Convert list to numeric


# Pull out removed KOIDs, their category classification, and their sole sample so I can update the KEGG pathway counts
koid.rem.names <- rownames(kegg.counts[koid.rem.row,])
kegg.path <- read.csv('KEGG/KOID_Pathway_Classifications.csv', header = T)
kegg.rem.path <- data.frame(matrix(nrow = length(koid.rem.row), ncol = 3))
colnames(kegg.rem.path) <- c("KOID", "Pathway", "Sample")
for(j in 1:length(koid.rem.names)){
  matchName = which(kegg.path[,4] == koid.rem.names[j])
  kegg.rem.path[j,1:2] <- kegg.path[matchName,3:4]
  
  matchSamp = which(rownames(kegg.counts) == koid.rem.names[j])
  yes <- which(kegg.counts[matchSamp,] != 0)
  kegg.rem.path[j,3] <- substr(colnames(kegg.counts)[yes], 2, 5)
}


# Pull out removed COGs, their category classification, and their sole sample so I can update the COG category counts
cog.rem.names <- rownames(cog.counts[cog.rem.row,])
cog.cat <- read.csv('cog/cog.classifications.tab', header = T, sep = "\t")
cog.rem.cat <- data.frame(matrix(nrow = length(cog.rem.row), ncol = 3))
colnames(cog.rem.cat) <- c("COG", "Category", "Sample")
for(j in 1:length(cog.rem.names)){
  matchName = which(cog.cat[,1] == cog.rem.names[j])
  cog.rem.cat[j,1:2] <- cog.cat[matchName,1:2]
  
  matchSamp = which(rownames(cog.counts) == cog.rem.names[j])
  yes <- which(cog.counts[matchSamp,] != 0)
  cog.rem.cat[j,3] <- substr(colnames(cog.counts)[yes], 2, 5)
}

cog.rem.cat.counts <- data.frame(matrix(nrow = 25, ncol = 11))
colnames(cog.rem.cat.counts) <- c("Category", "Count", "3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
cog.rem.cat.counts[,1] <- c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "Y", "Z")
cog.rem.cat.counts[,2:11] <- 0
for(k in 1:nrow(cog.rem.cat)){
  match <- length(which(grepl(cog.rem.cat[k,2], cog.rem.cat.counts[,1])))

  if(match > 0){
    matchRow <- which(grepl(cog.rem.cat[k,2], cog.rem.cat.counts[,1]))
    cog.rem.cat.counts[matchRow, 2] <- cog.rem.cat.counts[matchRow, 2] + 1
    sampCol <- which(colnames(cog.rem.cat.counts) == cog.rem.cat$Sample[k])
    cog.rem.cat.counts[matchRow, sampCol] <- cog.rem.cat.counts[matchRow, sampCol] + 1
  }
}


# Remove COGs that appear in only 1 sample
cog.rem <- cog.counts[-cog.rem.row,]
colnames(cog.rem) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")

# Format data
cog.df <- data.frame(t(cog.rem))
rownames(cog.df) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")
cog.df$Season <- c("Summer", "Summer", "Winter", "Winter", "Spring", "Summer", "Winter", "Spring", "Spring")
cog.df$Season <- ordered(cog.df$Season, levels=c("Summer", "Winter", "Spring"))

# Load COG "tax_table"
cog.cat <- read.csv('cog/cog.classifications.tab', header = T, sep = "\t")
cog.tax <- data.frame(cog.cat[,-2:-3])

# Prepare phyloseq object inputs
cog.otu <- otu_table(cog.rem, taxa_are_rows = T)
cog.tax <- tax_table(cog.tax)
taxa_names(cog.tax) <- cog.tax[,1]
meta <- read.csv('metadata.csv', row.names=1)

# Create phyloseq object
cog.phy <- merge_phyloseq(cog.otu, cog.tax, sample_data(meta))
colnames(tax_table(cog.phy)) <- "COG"
#save(cog.phy, file = "cog.phy.Rdata")



### Category-level ###

# Load data
cog.cat <- read.csv('cog/cog.category.csv', header = T, row.names = 1)
cog.cat.rem <- cog.rem.cat.counts[,3:11]
cog.cat.trim <- cog.cat - cog.cat.rem
cog.cat.otu <- otu_table(cog.cat.trim, taxa_are_rows = T)
colnames(cog.cat.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773", "3775")


# Create phyloseq object
cog.cat.tax <- data.frame(rownames(cog.cat.trim))
rownames(cog.cat.tax) <- cog.cat.tax[,1]
colnames(cog.cat.tax) <- "Category"
cog.cat.tax <- tax_table(cog.cat.tax)
taxa_names(cog.cat.tax) <- cog.cat.tax[,1]
colnames(cog.cat.tax) <- "Category"
cog.cat.phy <- merge_phyloseq(cog.cat.otu, cog.cat.tax, sample_data(meta))
#save(cog.cat.phy, file = "cog.cat.phy.Rdata")



### Category - Normalized Counts ###
cog.cat.dds <- phyloseq_to_deseq2(cog.cat.phy, ~Season)
cog.cat.dds <- estimateSizeFactors(cog.cat.dds)
cog.cat.norm <- counts(cog.cat.dds, normalized = T)
cog.cat.norm.phy <- merge_phyloseq(otu_table(cog.cat.norm, taxa_are_rows = T), tax_table(cog.cat.phy), sample_data(cog.cat.phy))
#save(cog.cat.norm.phy, file = "cog.cat.norm.phy.Rdata")




### Category - All Counts ###
cog.dds <- phyloseq_to_deseq2(cog.phy, ~Season)
cog.dds <- estimateSizeFactors(cog.dds)
cog.norm <- counts(cog.dds, normalized = T)
cog.norm.phy <- merge_phyloseq(otu_table(cog.norm, taxa_are_rows = T), tax_table(cog.phy), sample_data(cog.phy))
#save(cog.norm.phy, file = "cog.norm.phy.Rdata")
```